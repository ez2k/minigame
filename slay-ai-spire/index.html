<!DOCTYPE html>

<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Slay AI Spire v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes pulse { 0%,100% { box-shadow: 0 0 15px rgba(212,175,55,0.4); } 50% { box-shadow: 0 0 30px rgba(212,175,55,0.8); } }
    @keyframes pathPulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }
    @keyframes glow { 0%,100% { filter: drop-shadow(0 0 8px rgba(212,175,55,0.6)); } 50% { filter: drop-shadow(0 0 20px rgba(212,175,55,1)); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes cardEntrance { 
      0% { opacity: 0; transform: translateY(30px) rotateX(20deg); }
      100% { opacity: 1; transform: translateY(0) rotateX(0); }
    }
    @keyframes starTwinkle { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0f;
      color: #e8e4d9;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Î∞∞Í≤Ω ÌååÌã∞ÌÅ¥ Ìö®Í≥º */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(139, 69, 186, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(20, 20, 35, 0.8) 0%, transparent 80%);
      pointer-events: none;
      z-index: -1;
    }
    
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(212,175,55,0.4), transparent),
        radial-gradient(1px 1px at 50px 160px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 90px 40px, rgba(212,175,55,0.3), transparent),
        radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.4), transparent),
        radial-gradient(1px 1px at 160px 120px, rgba(139,69,186,0.4), transparent);
      background-size: 200px 200px;
      animation: starTwinkle 4s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    .hidden { display: none !important; }
    .gold { color: #f4d03f; text-shadow: 0 0 10px rgba(244,208,63,0.3); }
    .red { color: #ff4757; text-shadow: 0 0 10px rgba(255,71,87,0.3); }
    .blue { color: #54a0ff; text-shadow: 0 0 10px rgba(84,160,255,0.3); }
    .green { color: #5dfc7a; text-shadow: 0 0 10px rgba(93,252,122,0.3); }
    .purple { color: #c084fc; text-shadow: 0 0 10px rgba(192,132,252,0.3); }
    .muted { color: #6b7280; }
    .center { text-align: center; }

    /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 16px 32px; border: none; border-radius: 12px;
      font-family: 'Cinzel', 'Noto Sans KR', serif;
      font-size: 15px; font-weight: 600; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }
    .btn:hover::before { transform: translateX(100%); }
    .btn:active { transform: scale(0.96); }
    .btn-gold {
      background: linear-gradient(135deg, #b8860b, #d4af37, #f4d03f, #d4af37);
      background-size: 200% auto;
      color: #0a0a0f;
      box-shadow: 0 4px 25px rgba(212,175,55,0.4), inset 0 1px 0 rgba(255,255,255,0.3);
      text-shadow: 0 1px 0 rgba(255,255,255,0.3);
    }
    .btn-gold:hover {
      animation: shimmer 2s linear infinite;
      box-shadow: 0 8px 35px rgba(212,175,55,0.6), inset 0 1px 0 rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .btn-dark {
      background: rgba(20,20,35,0.8);
      color: #f4d03f;
      border: 1px solid rgba(212,175,55,0.4);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .btn-dark:hover {
      border-color: #f4d03f;
      box-shadow: 0 8px 30px rgba(212,175,55,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .btn-green {
      background: linear-gradient(135deg, #059669, #10b981, #34d399);
      color: #fff;
      box-shadow: 0 4px 20px rgba(16,185,129,0.4);
    }
    .btn-green:hover {
      box-shadow: 0 8px 30px rgba(16,185,129,0.6);
      transform: translateY(-2px);
    }
    .btn-sm { padding: 10px 18px; font-size: 13px; border-radius: 8px; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

    /* ÏÉÅÎã®Î∞î */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      background: linear-gradient(180deg, rgba(10,10,15,0.98) 0%, rgba(10,10,15,0.95) 100%);
      border-bottom: 1px solid rgba(212,175,55,0.15);
      padding: 14px 20px;
      backdrop-filter: blur(20px);
    }
    .top-bar-inner {
      max-width: 900px; margin: 0 auto;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 10px;
    }
    .stats { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .stat { 
      display: flex; gap: 6px; align-items: center; 
      font-size: 14px; font-weight: 500;
      padding: 6px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .top-btns { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .inv-slot {
      width: 40px; height: 40px;
      background: linear-gradient(145deg, rgba(30,30,45,0.9), rgba(20,20,30,0.9));
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .inv-slot:hover { 
      transform: scale(1.15) translateY(-3px); 
      border-color: #f4d03f;
      box-shadow: 0 8px 25px rgba(212,175,55,0.3);
    }

    /* Ïπ¥Îìú Ïä§ÌÉÄÏùº */
    .game-card {
      width: 120px; height: 170px;
      border-radius: 14px; padding: 12px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; flex-shrink: 0;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .game-card:hover:not(.disabled) { 
      transform: translateY(-15px) scale(1.08) rotateX(5deg); 
      box-shadow: 0 25px 50px rgba(0,0,0,0.6), 0 0 30px rgba(212,175,55,0.2);
    }
    .game-card:active:not(.disabled) { transform: scale(0.95); }
    .game-card.disabled { opacity: 0.35; cursor: not-allowed; filter: grayscale(50%); }
    .game-card.attack { 
      background: linear-gradient(160deg, rgba(80,20,20,0.9), rgba(40,10,10,0.95)); 
      border: 2px solid rgba(180,50,50,0.6);
    }
    .game-card.skill { 
      background: linear-gradient(160deg, rgba(20,50,80,0.9), rgba(10,25,45,0.95)); 
      border: 2px solid rgba(50,100,180,0.6);
    }
    .game-card.power { 
      background: linear-gradient(160deg, rgba(80,70,20,0.9), rgba(40,35,10,0.95)); 
      border: 2px solid rgba(180,150,50,0.6);
    }
    .game-card.upgraded { 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 25px rgba(74, 222, 128, 0.4);
    }
    .game-card.upgraded::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 16px;
      background: linear-gradient(45deg, transparent, rgba(74,222,128,0.3), transparent);
      z-index: -1;
    }
    .game-card.upgraded .card-name { color: #5dfc7a; }
    .card-cost {
      position: absolute; top: -10px; left: -10px;
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #f4d03f, #d4af37, #b8860b);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Cinzel', serif;
      font-weight: bold; font-size: 16px; color: #0a0a0f;
      box-shadow: 0 4px 15px rgba(212,175,55,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
      border: 2px solid rgba(255,255,255,0.2);
    }
    .card-icon { font-size: 34px; margin-bottom: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
    .card-name { 
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px; font-weight: 600; 
      color: #f4d03f; margin-bottom: 6px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .card-desc { 
      font-size: 11px; color: #b0b0b0; line-height: 1.4;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .card-upgrade-badge {
      position: absolute; top: -8px; right: -8px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      font-size: 10px; font-weight: bold;
      padding: 3px 7px; border-radius: 6px;
      box-shadow: 0 2px 10px rgba(34,197,94,0.5);
    }
    .game-card.small { width: 80px; height: 110px; }
    .game-card.small .card-cost { width: 24px; height: 24px; font-size: 12px; top: -6px; left: -6px; }
    .game-card.small .card-icon { font-size: 22px; }
    .game-card.small .card-name { font-size: 10px; }
    .game-card.small .card-desc { font-size: 8px; }

    /* Îç± Î™®Îã¨ Ï†ÑÏö© ÌÅ∞ Ïπ¥Îìú */
    #deckGrid .game-card { width: 160px; height: 220px; }
    #deckGrid .card-cost { width: 40px; height: 40px; font-size: 20px; top: -12px; left: -12px; }
    #deckGrid .card-icon { font-size: 44px; margin-bottom: 10px; }
    #deckGrid .card-name { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    #deckGrid .card-desc { font-size: 13px; line-height: 1.5; }

    /* Ï†Å Ïú†Îãõ */
    .enemy-container { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; }
    .enemy-unit { 
      text-align: center; padding: 20px; min-width: 160px;
      background: rgba(20,20,30,0.5);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.5s ease-out;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .enemy-emoji { font-size: 70px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
    .enemy-unit:nth-child(2) .enemy-emoji { animation-delay: 0.5s; }
    .enemy-unit:nth-child(3) .enemy-emoji { animation-delay: 1s; }
    .enemy-emoji.hit { animation: shake 0.3s ease-in-out; }
    .enemy-name { 
      font-family: 'Cinzel', 'Noto Sans KR', serif;
      font-size: 18px; font-weight: 600; 
      color: #f4d03f; margin: 12px 0;
      text-shadow: 0 2px 10px rgba(212,175,55,0.3);
    }
    .hp-bar { 
      width: 140px; height: 12px; 
      background: rgba(30,30,40,0.8); 
      border-radius: 6px; margin: 0 auto 8px; 
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    }
    .hp-fill { 
      height: 100%; 
      background: linear-gradient(90deg, #dc2626, #ef4444, #f87171); 
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(239,68,68,0.5);
    }
    .intent { 
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; 
      background: rgba(20,20,35,0.9); 
      border: 1px solid rgba(212,175,55,0.2); 
      border-radius: 20px; margin-top: 8px; 
      font-size: 13px; font-weight: 500;
      backdrop-filter: blur(10px);
    }
    .status { 
      display: inline-flex; align-items: center;
      padding: 4px 10px; border-radius: 12px; 
      font-size: 11px; font-weight: 600; margin: 3px;
      backdrop-filter: blur(5px);
    }
    .status.block { background: rgba(84,160,255,0.2); color: #54a0ff; border: 1px solid rgba(84,160,255,0.3); }
    .status.str { background: rgba(255,71,87,0.2); color: #ff6b7a; border: 1px solid rgba(255,71,87,0.3); }
    .status.vuln { background: rgba(255,165,0,0.2); color: #ffa500; border: 1px solid rgba(255,165,0,0.3); }
    .status.weak { background: rgba(100,200,100,0.2); color: #7ddc7d; border: 1px solid rgba(100,200,100,0.3); }
    .status.poison { background: rgba(168,85,247,0.2); color: #a855f7; border: 1px solid rgba(168,85,247,0.3); }
    .status.ritual { background: rgba(192,132,252,0.2); color: #c084fc; border: 1px solid rgba(192,132,252,0.3); }

    /* ÌîåÎ†àÏù¥Ïñ¥ Î∞î */
    .player-bar {
      background: linear-gradient(180deg, rgba(25,25,40,0.9), rgba(15,15,25,0.95));
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 20px; padding: 16px 24px; margin: 20px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 12px;
      backdrop-filter: blur(20px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .energy-orbs { display: flex; gap: 8px; }
    .orb {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; 
      font-size: 15px; font-weight: 700;
      transition: all 0.3s;
    }
    .orb.active { 
      background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); 
      box-shadow: 0 0 20px rgba(251,191,36,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
      color: #0a0a0f;
      animation: glow 2s ease-in-out infinite;
    }
    .orb.empty { 
      background: rgba(30,30,45,0.8); 
      border: 2px solid rgba(255,255,255,0.1);
      color: #4a4a5a;
    }

    .hand { 
      display: flex; justify-content: center; gap: 10px; 
      padding: 20px; flex-wrap: wrap;
    }

    /* ÌôîÎ©¥ Î†àÏù¥ÏïÑÏõÉ */
    .screen { 
      min-height: 100vh; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; padding: 30px;
      animation: fadeInUp 0.6s ease-out;
    }
    .title { 
      font-family: 'Cinzel', serif;
      font-size: 42px; font-weight: 700; 
      background: linear-gradient(135deg, #f4d03f, #d4af37, #f4d03f);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s linear infinite;
      margin-bottom: 10px;
      letter-spacing: 4px;
      filter: drop-shadow(0 4px 20px rgba(212,175,55,0.4));
    }
    .subtitle { 
      font-size: 16px; color: #8b8b9b; margin-bottom: 40px;
      letter-spacing: 2px;
    }
    .version { font-size: 12px; color: #4a4a5a; margin-top: 12px; }
    .menu-btns { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 300px; }

    /* Î™®Îã¨ */
    .modal { 
      position: fixed; inset: 0; 
      background: rgba(5,5,10,0.95); 
      z-index: 200; 
      display: flex; align-items: center; justify-content: center; 
      padding: 20px;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.3s ease-out;
    }
    .modal-box { 
      width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; 
      background: linear-gradient(160deg, rgba(30,30,45,0.98), rgba(15,15,25,0.98)); 
      border: 1px solid rgba(212,175,55,0.2); 
      border-radius: 24px; padding: 28px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset;
      backdrop-filter: blur(20px);
    }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { 
      font-family: 'Cinzel', 'Noto Sans KR', serif;
      font-size: 22px; font-weight: 600; 
      color: #f4d03f;
      text-shadow: 0 2px 10px rgba(212,175,55,0.3);
    }
    .modal-close { 
      width: 36px; height: 36px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 50%; color: #8b8b9b; font-size: 20px; cursor: pointer;
      transition: all 0.3s;
    }
    .modal-close:hover { 
      background: rgba(255,71,87,0.2); 
      border-color: rgba(255,71,87,0.4);
      color: #ff6b7a;
    }

    /* ÏÑ∏Ïù¥Î∏å Ïä¨Î°Ø */
    .save-slot { 
      background: linear-gradient(145deg, rgba(35,35,50,0.8), rgba(25,25,35,0.8)); 
      border: 1px solid rgba(255,255,255,0.08); 
      border-radius: 16px; padding: 18px; margin-bottom: 14px;
      transition: all 0.3s;
    }
    .save-slot:hover { border-color: rgba(212,175,55,0.3); }
    .save-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .save-name { font-weight: 600; color: #f4d03f; }
    .save-date { font-size: 11px; color: #6b7280; }
    .save-info { font-size: 13px; color: #8b8b9b; margin-bottom: 12px; }
    .save-btns { display: flex; gap: 10px; }
    .save-btns .btn { flex: 1; padding: 12px; font-size: 13px; }

    /* Îßµ */
    .map-box { 
      background: linear-gradient(180deg, rgba(20,20,35,0.8), rgba(15,15,25,0.9)); 
      border: 1px solid rgba(212,175,55,0.15); 
      border-radius: 20px; padding: 24px; 
      position: relative; overflow-x: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.03);
      backdrop-filter: blur(10px);
    }
    .map-container { position: relative; min-height: 540px; width: 100%; }
    .map-paths { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .map-path { stroke: rgba(100,100,120,0.2); stroke-width: 2; fill: none; }
    .map-path.accessible { 
      stroke: #f4d03f; stroke-width: 3; 
      filter: drop-shadow(0 0 12px rgba(244,208,63,0.8)); 
      animation: pathPulse 1.5s ease-in-out infinite; 
    }
    .map-path.visited { stroke: rgba(84,160,255,0.3); stroke-width: 2; }
    .map-floor { display: flex; justify-content: space-around; align-items: center; padding: 4px 10px; position: relative; z-index: 1; min-height: 40px; }
    .map-floor-label { position: absolute; left: -5px; font-size: 10px; color: #4a4a5a; font-weight: 600; }
    .map-row { display: flex; justify-content: center; gap: 14px; margin-bottom: 10px; position: relative; }
    .map-node {
      width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; transition: all 0.3s; position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    .map-node.accessible { 
      background: rgba(244,208,63,0.15); 
      border: 2px solid #f4d03f; cursor: pointer; 
      animation: pulse 2s infinite;
    }
    .map-node.accessible:hover { 
      transform: scale(1.2); 
      box-shadow: 0 0 30px rgba(244,208,63,0.6);
      background: rgba(244,208,63,0.25);
    }
    .map-node.visited { 
      background: rgba(50,50,60,0.5); 
      border: 1px solid rgba(255,255,255,0.08); opacity: 0.4; 
    }
    .map-node.current { 
      background: rgba(93,252,122,0.2); 
      border: 2px solid #5dfc7a; 
      box-shadow: 0 0 30px rgba(93,252,122,0.5); 
      transform: scale(1.15);
    }
    .map-node.locked { 
      background: rgba(30,30,45,0.3); 
      border: 1px solid rgba(255,255,255,0.03); opacity: 0.25; 
    }
    .legend { 
      display: flex; flex-wrap: wrap; justify-content: center; 
      gap: 14px; font-size: 12px; color: #8b8b9b; margin-bottom: 16px;
    }

    /* Ïù¥Î≤§Ìä∏ Î∞ïÏä§ */
    .event-box { 
      width: 100%; max-width: 440px; 
      background: linear-gradient(160deg, rgba(30,30,50,0.95), rgba(15,15,30,0.98)); 
      border: 1px solid rgba(168,85,247,0.3); 
      border-radius: 24px; padding: 32px; text-align: center;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5), 0 0 60px rgba(168,85,247,0.1);
      animation: fadeInUp 0.5s ease-out;
    }
    .event-emoji { font-size: 72px; margin-bottom: 16px; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5)); }
    .event-title { 
      font-family: 'Cinzel', 'Noto Sans KR', serif;
      font-size: 26px; font-weight: 600; 
      color: #f4d03f; margin-bottom: 10px;
      text-shadow: 0 2px 15px rgba(212,175,55,0.4);
    }
    .event-desc { font-size: 15px; color: #a0a0b0; margin-bottom: 28px; line-height: 1.7; }
    .choice-btn { 
      width: 100%; padding: 18px 24px; margin-bottom: 12px; 
      background: rgba(168,85,247,0.1); 
      border: 1px solid rgba(168,85,247,0.3); 
      border-radius: 14px; color: #e8e4d9; font-size: 15px; 
      cursor: pointer; text-align: left; transition: all 0.3s;
      backdrop-filter: blur(5px);
    }
    .choice-btn:hover { 
      background: rgba(168,85,247,0.2); 
      transform: translateX(8px);
      border-color: rgba(168,85,247,0.5);
      box-shadow: 0 5px 20px rgba(168,85,247,0.2);
    }
    .choice-btn:active { transform: scale(0.98); }
    .choice-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .quick-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 28px; width: 100%; max-width: 320px; }
    .quick-btn { 
      padding: 18px; 
      background: rgba(244,208,63,0.08); 
      border: 1px solid rgba(244,208,63,0.3); 
      border-radius: 16px; color: #f4d03f; font-size: 22px; cursor: pointer; 
      transition: all 0.3s;
      backdrop-filter: blur(5px);
    }
    .quick-btn:hover { 
      background: rgba(244,208,63,0.15);
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(244,208,63,0.2);
    }
    .quick-btn:active { transform: scale(0.96); }

    /* AI Î©îÏãúÏßÄ */
    .ai-msg { 
      background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(139,69,186,0.15)); 
      border: 1px solid rgba(168,85,247,0.25); 
      border-radius: 16px; padding: 14px 24px; margin: 16px auto; max-width: 450px; text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(168,85,247,0.1);
    }
    .ai-msg p { color: #d4b8ff; font-style: italic; font-size: 15px; letter-spacing: 0.3px; }
    .game-msg { 
      text-align: center; 
      color: #f4d03f; font-size: 16px; font-weight: 600; 
      margin: 12px 0; min-height: 28px;
      text-shadow: 0 2px 10px rgba(244,208,63,0.3);
    }

    /* ÏÉÅÏ†ê */
    .shop-section { margin-bottom: 28px; }
    .shop-title { 
      font-family: 'Cinzel', 'Noto Sans KR', serif;
      font-size: 18px; font-weight: 600; 
      color: #f4d03f; margin-bottom: 14px;
      text-shadow: 0 2px 10px rgba(212,175,55,0.2);
    }
    .shop-items { display: flex; gap: 14px; overflow-x: auto; padding-bottom: 10px; }
    .shop-item { 
      background: linear-gradient(145deg, rgba(35,35,50,0.9), rgba(20,20,30,0.9)); 
      border: 1px solid rgba(212,175,55,0.15); 
      border-radius: 16px; padding: 14px; cursor: pointer; flex-shrink: 0; 
      transition: all 0.3s;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    .shop-item:hover { 
      border-color: #f4d03f; 
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(212,175,55,0.2);
    }
    .shop-item.sold { opacity: 0.25; pointer-events: none; filter: grayscale(80%); }
    .shop-price { 
      text-align: center; color: #f4d03f; font-weight: 700; margin-top: 10px; font-size: 14px;
      text-shadow: 0 2px 8px rgba(212,175,55,0.3);
    }
    .shop-service { 
      background: linear-gradient(145deg, rgba(35,35,50,0.8), rgba(20,20,30,0.8)); 
      border: 1px solid rgba(212,175,55,0.15); 
      border-radius: 14px; padding: 18px; margin-bottom: 12px; 
      display: flex; justify-content: space-between; align-items: center; 
      cursor: pointer; transition: all 0.3s;
    }
    .shop-service:hover { 
      border-color: #f4d03f;
      transform: translateX(5px);
    }

    /* Îç± Í∑∏Î¶¨Îìú */
    .deck-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 14px; padding: 16px 0; }
    .deck-filter { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center; }
    .deck-filter button { 
      padding: 8px 16px; 
      background: rgba(255,255,255,0.05); 
      border: 1px solid rgba(255,255,255,0.1); 
      border-radius: 10px; color: #8b8b9b; font-size: 13px; cursor: pointer;
      transition: all 0.3s;
    }
    .deck-filter button:hover { background: rgba(255,255,255,0.08); }
    .deck-filter button.active { 
      background: rgba(244,208,63,0.15); 
      border-color: rgba(244,208,63,0.5); 
      color: #f4d03f;
    }

    /* Í≤∞Í≥º ÌôîÎ©¥ */
    .result-emoji { font-size: 90px; margin-bottom: 20px; filter: drop-shadow(0 15px 40px rgba(0,0,0,0.5)); }
    .result-title { 
      font-family: 'Cinzel', serif;
      font-size: 40px; font-weight: 700; margin-bottom: 10px;
      letter-spacing: 4px;
    }
    .result-title.win { 
      background: linear-gradient(135deg, #f4d03f, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 4px 20px rgba(244,208,63,0.4));
    }
    .result-title.lose { 
      color: #ff4757;
      text-shadow: 0 4px 20px rgba(255,71,87,0.4);
    }
    .result-sub { font-size: 16px; color: #8b8b9b; margin-bottom: 28px; }
    .result-stats { 
      background: linear-gradient(145deg, rgba(35,35,50,0.8), rgba(25,25,35,0.8)); 
      border: 1px solid rgba(255,255,255,0.08); 
      border-radius: 16px; padding: 24px; margin-bottom: 28px; 
      font-size: 15px; color: #a0a0b0; line-height: 2;
    }

    /* Ï†ÑÌà¨ Î°úÍ∑∏ */
    .combat-log { 
      max-height: 90px; overflow-y: auto; 
      background: rgba(10,10,15,0.6); 
      border-radius: 12px; padding: 12px; margin: 10px 20px; 
      font-size: 12px; color: #6b7280;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .combat-log p { margin: 3px 0; }
    .combat-log .dmg { color: #ff6b7a; }
    .combat-log .heal { color: #5dfc7a; }
    .combat-log .block { color: #54a0ff; }

    /* Ìà¥ÌåÅ */
    .tooltip { 
      position: fixed; 
      background: linear-gradient(145deg, rgba(30,30,50,0.98), rgba(20,20,35,0.98)); 
      border: 1px solid rgba(212,175,55,0.3); 
      border-radius: 12px; padding: 16px; max-width: 220px; 
      z-index: 1000; pointer-events: none;
      box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
    }
    .tooltip-title { color: #f4d03f; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
.tooltip-desc { color: #aaa; font-size: 12px; line-height: 1.4; }

.target-indicator { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); color: #d4af37; font-size: 20px; animation: bounce 0.5s infinite; }
@keyframes bounce { 0%,100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }

@media (max-width: 480px) {
  .title { font-size: 26px; }
  .game-card { width: 80px; height: 115px; }
  .game-card .card-icon { font-size: 20px; }
  .game-card .card-name { font-size: 9px; }
  .game-card .card-desc { font-size: 7px; }
  .enemy-emoji { font-size: 45px; }
  .enemy-name { font-size: 14px; }
  .enemy-unit { min-width: 100px; padding: 10px; }
  .hp-bar { width: 100px; }
  .hand { gap: 5px; padding: 10px; }
  .top-bar-inner { font-size: 12px; }
  .stat { font-size: 12px; }
  .inv-slot { width: 30px; height: 30px; font-size: 14px; }
  .map-node { width: 38px; height: 38px; font-size: 16px; }
}

  </style>
</head>
<body>
  <div class="top-bar hidden" id="topBar">
    <div class="top-bar-inner">
      <div class="stats">
        <span class="gold">üèîÔ∏è <span id="floorNum">1</span>Ï∏µ</span>
        <div class="stat"><span class="red">‚ù§Ô∏è</span><span id="hpText">80/80</span></div>
        <div class="stat"><span class="gold">üí∞</span><span id="goldText">99</span></div>
      </div>
      <div class="top-btns">
        <div id="potionSlots" style="display:flex;gap:4px;"></div>
        <div id="relicSlots" style="display:flex;gap:4px;"></div>
        <button class="btn btn-dark btn-sm" onclick="showDeck()">Îç±</button>
        <button class="btn btn-dark btn-sm" onclick="showMap()">Îßµ</button>
        <button class="btn btn-dark btn-sm" onclick="showSaveMenu()">üíæ</button>
      </div>
    </div>
  </div>

  <div class="screen" id="menuScreen">
    <div class="title">‚öîÔ∏è SLAY AI SPIRE ‚öîÔ∏è</div>
    <div class="subtitle">Îç±ÎπåÎî© Î°úÍ∑∏ÎùºÏù¥ÌÅ¨</div>
    <div class="menu-btns">
      <button class="btn btn-gold" onclick="startGame()">ÏÉà Í≤åÏûÑ</button>
      <button class="btn btn-dark hidden" id="continueBtn" onclick="loadAutoSave()">Ïù¥Ïñ¥ÌïòÍ∏∞</button>
      <button class="btn btn-dark" onclick="showSaveMenu()">Ï†ÄÏû• Ïä¨Î°Ø</button>
    </div>
    <div class="version">v2.0 - ÏóÖÍ∑∏Î†àÏù¥Îìú & Î∞∏Îü∞Ïä§ Ìå®Ïπò</div>
  </div>

  <div class="screen hidden" id="mapScreen" style="padding-top:70px;">
    <div class="ai-msg" id="mapAiMsg"><p></p></div>
    <div class="game-msg" id="mapMsg"></div>
    <p class="muted" style="margin-bottom:16px;">Í≤ΩÎ°úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
    <button class="btn btn-gold" onclick="showMap()">üó∫Ô∏è Îßµ Ïó¥Í∏∞</button>
    <div class="quick-grid" id="quickSelect"></div>
  </div>

  <div class="hidden" id="combatScreen" style="padding-top:70px;padding-bottom:20px;">
    <div class="ai-msg" id="combatAiMsg"><p></p></div>
    <div class="enemy-container" id="enemyContainer"></div>
    <div class="combat-log" id="combatLog"></div>
    <div class="game-msg" id="combatMsg"></div>
    <div class="player-bar">
      <div class="stats" style="flex-wrap:wrap;">
        <div class="stat"><span class="red">‚ù§Ô∏è</span><span id="playerHp">80/80</span></div>
        <div class="stat" id="playerBlock" style="display:none;"><span class="blue">üõ°Ô∏è</span><span></span></div>
        <span id="playerStr" class="status str" style="display:none;"></span>
        <span id="playerDex" class="status block" style="display:none;"></span>
        <span id="playerWeak" class="status weak" style="display:none;"></span>
        <span id="playerVuln" class="status vuln" style="display:none;"></span>
        <span id="playerPoison" class="status poison" style="display:none;"></span>
      </div>
      <div class="energy-orbs" id="energyOrbs"></div>
    </div>
    <div class="muted center" style="font-size:12px;">ÎΩëÍ∏∞: <span id="drawCount">0</span> | Î≤ÑÎ¶º: <span id="discardCount">0</span> | ÏÜåÎ©∏: <span id="exhaustCount">0</span></div>
    <div class="hand" id="handArea"></div>
    <div class="center" style="margin-top:12px;">
      <button class="btn btn-gold" id="endTurnBtn" onclick="endTurn()">ÌÑ¥ Ï¢ÖÎ£å</button>
    </div>
  </div>

  <div class="screen hidden" id="rewardScreen" style="padding-top:70px;">
    <div class="event-box">
      <div class="event-emoji">üéâ</div>
      <div class="event-title">ÏäπÎ¶¨!</div>
      <div id="rewardContent"></div>
    </div>
  </div>

  <div class="screen hidden" id="eventScreen" style="padding-top:70px;">
    <div class="event-box" id="eventBox"></div>
  </div>

  <div class="screen hidden" id="restScreen" style="padding-top:70px;">
    <div class="event-box" id="restBox"></div>
  </div>

  <div class="hidden" id="shopScreen" style="padding:70px 16px 24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2 class="gold" style="font-size:22px;">üõí ÏÉÅÏ†ê</h2>
      <span class="gold" style="font-size:18px;">üí∞ <span id="shopGold">0</span></span>
    </div>
    <div class="ai-msg" id="shopAiMsg"><p></p></div>
    <div class="game-msg" id="shopMsg"></div>
    <div id="shopContent"></div>
    <button class="btn btn-dark" style="margin-top:16px;" onclick="exitShop()">ÎÇòÍ∞ÄÍ∏∞</button>
  </div>

  <div class="screen hidden" id="victoryScreen">
    <div class="result-emoji">üèÜ</div>
    <div class="result-title win">ÏäπÎ¶¨!</div>
    <div class="result-sub">Ï≤®ÌÉëÏùÑ Ï†ïÎ≥µÌïòÏòÄÏäµÎãàÎã§</div>
    <div class="result-stats" id="victoryStats"></div>
    <button class="btn btn-gold" onclick="goToMenu()">Îã§Ïãú ÎèÑÏ†Ñ</button>
  </div>

  <div class="screen hidden" id="defeatScreen">
    <div class="result-emoji">üíÄ</div>
    <div class="result-title lose">Ìå®Î∞∞</div>
    <div class="result-sub" id="defeatSub"></div>
    <div class="result-stats" id="defeatStats"></div>
    <button class="btn btn-dark" onclick="goToMenu()">Îã§Ïãú ÎèÑÏ†Ñ</button>
  </div>

  <div class="modal hidden" id="saveModal">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title">üíæ Ï†ÄÏû• / Î∂àÎü¨Ïò§Í∏∞</div>
        <button class="modal-close" onclick="closeSaveMenu()">√ó</button>
      </div>
      <div id="saveMsg" class="center gold" style="margin-bottom:12px;"></div>
      <div id="saveSlots"></div>
    </div>
  </div>

  <div class="modal hidden" id="deckModal">
    <div class="modal-box" style="max-width:800px;">
      <div class="modal-head">
        <div class="modal-title">üìö Îç± (<span id="deckCount">0</span>Ïû•)</div>
        <button class="modal-close" onclick="closeDeck()">√ó</button>
      </div>
      <div class="deck-filter" id="deckFilter"></div>
      <div class="deck-grid" id="deckGrid"></div>
    </div>
  </div>

  <div class="modal hidden" id="mapModal">
    <div class="modal-box" style="max-width:480px;">
      <div class="modal-head">
        <div class="modal-title">üó∫Ô∏è Îßµ</div>
        <button class="modal-close" onclick="closeMap()">√ó</button>
      </div>
      <div class="legend" id="mapLegend"></div>
      <div class="map-box" id="mapBox"></div>
    </div>
  </div>

  <div class="modal hidden" id="upgradeModal">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title">‚¨ÜÔ∏è Ïπ¥Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú</div>
        <button class="modal-close" onclick="closeUpgrade()">√ó</button>
      </div>
      <p class="muted center" style="margin-bottom:16px;">ÏóÖÍ∑∏Î†àÏù¥ÎìúÌï† Ïπ¥ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
      <div class="deck-grid" id="upgradeGrid"></div>
    </div>
  </div>

  <div class="modal hidden" id="itemInfoModal" onclick="closeItemInfo()">
    <div class="modal-box" style="max-width:320px;" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title" id="itemInfoTitle">ÏïÑÏù¥ÌÖú</div>
        <button class="modal-close" onclick="closeItemInfo()">√ó</button>
      </div>
      <div style="text-align:center;">
        <div style="font-size:64px;margin-bottom:16px;" id="itemInfoEmoji">üéÅ</div>
        <div style="font-size:18px;font-weight:600;color:#f4d03f;margin-bottom:12px;" id="itemInfoName">Ïù¥Î¶Ñ</div>
        <div style="font-size:14px;color:#a0a0b0;line-height:1.6;margin-bottom:20px;" id="itemInfoDesc">ÏÑ§Î™Ö</div>
        <div id="itemInfoAction"></div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="removeModal">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title">üóëÔ∏è Ïπ¥Îìú Ï†úÍ±∞</div>
        <button class="modal-close" onclick="closeRemove()">√ó</button>
      </div>
      <p class="muted center" style="margin-bottom:16px;">Ï†úÍ±∞Ìï† Ïπ¥ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
      <div class="deck-grid" id="removeGrid"></div>
    </div>
  </div>

  <div id="tooltip" class="tooltip hidden"></div>

  <script>
    // ========== Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ (ÏóÖÍ∑∏Î†àÏù¥Îìú Ìè¨Ìï®) ==========
    const CARDS = {
      // Í∏∞Î≥∏ Ïπ¥Îìú
      strike: { name: 'ÌÉÄÍ≤©', cost: 1, type: 'attack', damage: 6, desc: '6 Îç∞ÎØ∏ÏßÄ', upgradedName: 'ÌÉÄÍ≤©+', upgradedDamage: 9, upgradedDesc: '9 Îç∞ÎØ∏ÏßÄ' },
      defend: { name: 'ÏàòÎπÑ', cost: 1, type: 'skill', block: 5, desc: '5 Î∞©Ïñ¥ÎèÑ', upgradedName: 'ÏàòÎπÑ+', upgradedBlock: 8, upgradedDesc: '8 Î∞©Ïñ¥ÎèÑ' },
      bash: { name: 'Í∞ïÌÉÄ', cost: 2, type: 'attack', damage: 8, vulnerable: 2, desc: '8 ÎéÄ, Ï∑®ÏïΩ2', upgradedName: 'Í∞ïÌÉÄ+', upgradedDamage: 10, upgradedVulnerable: 3, upgradedDesc: '10 ÎéÄ, Ï∑®ÏïΩ3' },
      // Í≥µÍ≤© Ïπ¥Îìú
      cleave: { name: 'Í∞ÄÎ•¥Í∏∞', cost: 1, type: 'attack', damage: 8, aoe: true, desc: 'Ï†ÑÏ≤¥ 8 Îç∞ÎØ∏ÏßÄ', upgradedName: 'Í∞ÄÎ•¥Í∏∞+', upgradedDamage: 11, upgradedDesc: 'Ï†ÑÏ≤¥ 11 Îç∞ÎØ∏ÏßÄ' },
      ironWave: { name: 'Ï≤†Î≤ΩÌååÎèô', cost: 1, type: 'attack', damage: 5, block: 5, desc: '5 Î∞©Ïñ¥, 5 ÎéÄ', upgradedName: 'Ï≤†Î≤ΩÌååÎèô+', upgradedDamage: 7, upgradedBlock: 7, upgradedDesc: '7 Î∞©Ïñ¥, 7 ÎéÄ' },
      pommel: { name: 'ÏÜêÏû°Ïù¥', cost: 1, type: 'attack', damage: 9, draw: 1, desc: '9 ÎéÄ, 1ÎìúÎ°úÏö∞', upgradedName: 'ÏÜêÏû°Ïù¥+', upgradedDamage: 10, upgradedDraw: 2, upgradedDesc: '10 ÎéÄ, 2ÎìúÎ°úÏö∞' },
      anger: { name: 'Î∂ÑÎÖ∏', cost: 0, type: 'attack', damage: 6, addCopy: true, desc: '6 ÎéÄ, Î≥µÏÇ¨Î≥∏ Ï∂îÍ∞Ä', upgradedName: 'Î∂ÑÎÖ∏+', upgradedDamage: 8, upgradedDesc: '8 ÎéÄ, Î≥µÏÇ¨Î≥∏ Ï∂îÍ∞Ä' },
      carnage: { name: 'ÎåÄÌïôÏÇ¥', cost: 2, type: 'attack', damage: 20, exhaust: true, desc: '20 ÎéÄ, ÏÜåÎ©∏', upgradedName: 'ÎåÄÌïôÏÇ¥+', upgradedDamage: 28, upgradedDesc: '28 ÎéÄ, ÏÜåÎ©∏' },
      heavyBlade: { name: 'Ìó§ÎπÑÎ∏îÎ†àÏù¥Îìú', cost: 2, type: 'attack', damage: 14, strMult: 3, desc: '14 ÎéÄ (Ìûòx3)', upgradedName: 'Ìó§ÎπÑÎ∏îÎ†àÏù¥Îìú+', upgradedDamage: 14, upgradedStrMult: 5, upgradedDesc: '14 ÎéÄ (Ìûòx5)' },
      twinStrike: { name: 'ÏåçÎë•Ïù¥ÌÉÄÍ≤©', cost: 1, type: 'attack', damage: 5, times: 2, desc: '5 ÎéÄ x2', upgradedName: 'ÏåçÎë•Ïù¥ÌÉÄÍ≤©+', upgradedDamage: 7, upgradedDesc: '7 ÎéÄ x2' },
      bodySlam: { name: 'Î™∏ÌÜµÎ∞ïÏπòÍ∏∞', cost: 1, type: 'attack', blockDamage: true, desc: 'Î∞©Ïñ¥ÎèÑÎßåÌÅº ÎéÄ', upgradedName: 'Î™∏ÌÜµÎ∞ïÏπòÍ∏∞+', upgradedCost: 0, upgradedDesc: 'Î∞©Ïñ¥ÎèÑÎßåÌÅº ÎéÄ' },
      clothesline: { name: 'Îπ®Îû´Ï§Ñ', cost: 2, type: 'attack', damage: 12, weak: 2, desc: '12 ÎéÄ, ÏïΩÌôî2', upgradedName: 'Îπ®Îû´Ï§Ñ+', upgradedDamage: 14, upgradedWeak: 3, upgradedDesc: '14 ÎéÄ, ÏïΩÌôî3' },
      // Ïä§ÌÇ¨ Ïπ¥Îìú
      shrug: { name: 'Îñ®Ï≥êÎÇ¥Í∏∞', cost: 1, type: 'skill', block: 8, draw: 1, desc: '8 Î∞©Ïñ¥, 1ÎìúÎ°úÏö∞', upgradedName: 'Îñ®Ï≥êÎÇ¥Í∏∞+', upgradedBlock: 11, upgradedDesc: '11 Î∞©Ïñ¥, 1ÎìúÎ°úÏö∞' },
      armaments: { name: 'Î¨¥Ïû•', cost: 1, type: 'skill', block: 5, upgradeHand: true, desc: '5 Î∞©Ïñ¥, ÏÜêÌå® 1Ïû• ÏóÖÍ∏Ä', upgradedName: 'Î¨¥Ïû•+', upgradedBlock: 5, upgradedUpgradeAll: true, upgradedDesc: '5 Î∞©Ïñ¥, ÏÜêÌå® Ï†ÑÎ∂Ä ÏóÖÍ∏Ä' },
      shroud: { name: 'ÏùÄÌèê', cost: 1, type: 'skill', block: 6, exhaust: true, desc: '6 Î∞©Ïñ¥, ÏÜåÎ©∏', upgradedName: 'ÏùÄÌèê+', upgradedBlock: 10, upgradedDesc: '10 Î∞©Ïñ¥, ÏÜåÎ©∏' },
      truGrit: { name: 'ÏßÑÏ†ïÌïú Ìà¨ÏßÄ', cost: 1, type: 'skill', block: 7, exhaustRandom: true, desc: '7 Î∞©Ïñ¥, ÏÜêÌå® 1Ïû• ÏÜåÎ©∏', upgradedName: 'ÏßÑÏ†ïÌïú Ìà¨ÏßÄ+', upgradedBlock: 9, upgradedExhaustChoice: true, upgradedDesc: '9 Î∞©Ïñ¥, ÏÑ†ÌÉù ÏÜåÎ©∏' },
      battleTrance: { name: 'Ï†ÑÌà¨ Î¨¥ÏïÑÏßÄÍ≤Ω', cost: 0, type: 'skill', draw: 3, cantDraw: true, desc: '3 ÎìúÎ°úÏö∞, Ïù¥Î≤àÌÑ¥ Ï∂îÍ∞Ä ÎìúÎ°úÏö∞ Î∂àÍ∞Ä', upgradedName: 'Ï†ÑÌà¨ Î¨¥ÏïÑÏßÄÍ≤Ω+', upgradedDraw: 4, upgradedDesc: '4 ÎìúÎ°úÏö∞, Ïù¥Î≤àÌÑ¥ Ï∂îÍ∞Ä ÎìúÎ°úÏö∞ Î∂àÍ∞Ä' },
      bloodletting: { name: 'ÏÇ¨Ìòà', cost: 0, type: 'skill', selfDamage: 3, gainEnergy: 2, desc: 'HP -3, ÏóêÎÑàÏßÄ +2', upgradedName: 'ÏÇ¨Ìòà+', upgradedGainEnergy: 3, upgradedDesc: 'HP -3, ÏóêÎÑàÏßÄ +3' },
      // ÌååÏõå Ïπ¥Îìú
      inflame: { name: 'Ï†êÌôî', cost: 1, type: 'power', strength: 2, desc: 'Ìûò +2', upgradedName: 'Ï†êÌôî+', upgradedStrength: 3, upgradedDesc: 'Ìûò +3' },
      metal: { name: 'Í∏àÏÜçÌôî', cost: 1, type: 'power', endBlock: 3, desc: 'ÌÑ¥ÎßàÎã§ 3 Î∞©Ïñ¥', upgradedName: 'Í∏àÏÜçÌôî+', upgradedEndBlock: 4, upgradedDesc: 'ÌÑ¥ÎßàÎã§ 4 Î∞©Ïñ¥' },
      demon: { name: 'ÏïÖÎßàÌòïÏÉÅ', cost: 3, type: 'power', strPerTurn: 2, desc: 'ÌÑ¥ÎßàÎã§ Ìûò+2', upgradedName: 'ÏïÖÎßàÌòïÏÉÅ+', upgradedStrPerTurn: 3, upgradedDesc: 'ÌÑ¥ÎßàÎã§ Ìûò+3' },
      rage: { name: 'Î∂ÑÎÖ∏', cost: 0, type: 'power', blockOnAttack: 3, desc: 'Í≥µÍ≤©Ïãú 3 Î∞©Ïñ¥', upgradedName: 'Î∂ÑÎÖ∏+', upgradedBlockOnAttack: 5, upgradedDesc: 'Í≥µÍ≤©Ïãú 5 Î∞©Ïñ¥' },
      juggernaut: { name: 'Ï†ÄÍ±∞ÎÑàÌä∏', cost: 2, type: 'power', damageOnBlock: 5, desc: 'Î∞©Ïñ¥ÎèÑ ÌöçÎìùÏãú 5 ÎéÄ', upgradedName: 'Ï†ÄÍ±∞ÎÑàÌä∏+', upgradedDamageOnBlock: 7, upgradedDesc: 'Î∞©Ïñ¥ÎèÑ ÌöçÎìùÏãú 7 ÎéÄ' },
    };

    // ========== Ï†Å Îç∞Ïù¥ÌÑ∞ ==========
    const ENEMIES = {
      // Act 1 ÏùºÎ∞ò (Î∞∏Îü∞Ïä§ Ï°∞Ï†ï)
      cultist: { name: 'Í¥ëÏã†ÎèÑ', hp: [38, 44], emoji: 'üßô‚Äç‚ôÇÔ∏è', atks: [{ dmg: 5, name: 'ÏùòÏãù ÏπºÎÇ†' }, { ritual: 2, name: 'ÏùòÏãù' }] },
      jawWorm: { name: 'ÌÑ± Î≤åÎ†à', hp: [36, 40], emoji: 'üêõ', atks: [{ dmg: 8, name: 'Î¨ºÍ∏∞' }, { block: 5, str: 3, name: 'ÏõÖÌÅ¨Î¶¨Í∏∞' }, { dmg: 5, name: 'ÎèåÏßÑ' }] },
      slimeS: { name: 'ÏûëÏùÄ Ïä¨ÎùºÏûÑ', hp: [10, 14], emoji: 'üü¢', atks: [{ dmg: 4, name: 'Ï∞∞Ïãπ' }] },
      slimeM: { name: 'Ïä¨ÎùºÏûÑ', hp: [24, 28], emoji: 'üü°', atks: [{ dmg: 6, name: 'Ï∞∞Ïãπ' }, { dmg: 8, weak: 1, name: 'Ìï•Í∏∞' }] },
      looter: { name: 'ÏïΩÌÉàÏûê', hp: [38, 44], emoji: 'ü¶π', atks: [{ dmg: 8, name: 'ÌéÄÏπò' }, { dmg: 10, name: 'Ïä¨ÎûòÏãú' }, { escape: true, name: 'ÎèÑÏ£º' }] },
      // Act 1 ÏóòÎ¶¨Ìä∏ (HP 20% Í∞êÏÜå, Îç∞ÎØ∏ÏßÄ Ï°∞Ï†ï)
      gremlinNob: { name: 'Í∑∏Î†òÎ¶∞ ÎåÄÏû•', hp: [65, 70], emoji: 'üë∫', elite: true, atks: [{ dmg: 10, name: 'ÎèåÏßÑ' }, { dmg: 14, name: 'Ìï¥Í≥® Î∂ÄÏàòÍ∏∞' }, { str: 2, name: 'Î∂ÑÎÖ∏' }] },
      lagavulin: { name: 'ÎùºÍ∞ÄÎ∂àÎ¶∞', hp: [85, 95], emoji: 'üòà', elite: true, sleeping: true, atks: [{ dmg: 14, name: 'Í≥µÍ≤©' }, { debuff: true, strDown: 1, dexDown: 1, name: 'ÏÇ¨Ïù¥ÌéÄ ÏÜåÏö∏' }] },
      sentries: { name: 'ÌååÏàòÍæº', hp: [30, 35], emoji: 'ü§ñ', elite: true, count: 3, atks: [{ dmg: 7, name: 'Î†àÏù¥Ï†Ä' }, { status: 'dazed', name: 'ÌòºÎûÄ' }] },
      // Act 1 Î≥¥Ïä§ (HP 15% Í∞êÏÜå, Îç∞ÎØ∏ÏßÄ Ï°∞Ï†ï)
      slimeBoss: { name: 'Ïä¨ÎùºÏûÑ Î≥¥Ïä§', hp: [120, 130], emoji: 'üü©', boss: true, atks: [{ dmg: 25, name: 'Ïä¨Îû®' }, { split: true, name: 'Î∂ÑÏó¥' }] },
      guardian: { name: 'ÏàòÌò∏Ïûê', hp: [200, 215], emoji: 'ü§ñ', boss: true, atks: [{ dmg: 4, times: 4, name: 'Ï≤†Î≤Ω ÎÇúÌÉÄ' }, { dmg: 26, name: 'Í≤©Î†¨Ìïú Í≥µÍ≤©' }, { block: 8, dmg: 6, name: 'Ï∂©Ï†Ñ Î∞©Ìå®' }] },
      hexaghost: { name: 'Ìó•ÏÇ¨Í≥†Ïä§Ìä∏', hp: [210, 225], emoji: 'üëª', boss: true, atks: [{ dmg: 2, times: 5, name: 'ÌôúÏÑ±Ìôî' }, { dmg: 5, times: 5, name: 'Î∂ÑÎÖ∏' }, { dmg: 35, name: 'ÏßÄÏò•Î∂à' }] },
    };

    // ========== Î†êÎ¶≠ Îç∞Ïù¥ÌÑ∞ ==========
    const RELICS = {
      blood: { name: 'Î∂àÌÉÄÎäî Ìîº', emoji: 'ü©∏', desc: 'Ï†ÑÌà¨ ÌõÑ HP 6 ÌöåÎ≥µ', heal: 6 },
      anchor: { name: 'Îãª', emoji: '‚öì', desc: 'Ï†ÑÌà¨ ÏãúÏûëÏãú Î∞©Ïñ¥ÎèÑ 10', startBlock: 10 },
      vajra: { name: 'Í∏àÍ∞ïÏ†Ä', emoji: 'üíé', desc: 'Ï†ÑÌà¨ ÏãúÏûëÏãú Ìûò +1', startStr: 1 },
      lantern: { name: 'Îì±Î∂à', emoji: 'üèÆ', desc: 'Ï†ÑÌà¨ Ï≤´ ÌÑ¥ ÏóêÎÑàÏßÄ +1', firstTurnEnergy: 1 },
      oddMushroom: { name: 'Ïù¥ÏÉÅÌïú Î≤ÑÏÑØ', emoji: 'üçÑ', desc: 'Ï†ÅÏóêÍ≤å Ï∑®ÏïΩ 1 Î∂ÄÏó¨', startVuln: 1 },
      bagOfMarbles: { name: 'Íµ¨Ïä¨ Ï£ºÎ®∏Îãà', emoji: 'üîÆ', desc: 'Ï†ÑÌà¨ ÏãúÏûëÏãú Ï†Å Ï†ÑÏ≤¥ Ï∑®ÏïΩ 1', startVulnAll: 1 },
      redSkull: { name: 'Î∂âÏùÄ Ìï¥Í≥®', emoji: 'üíÄ', desc: 'HP 50% Ïù¥ÌïòÏãú Ìûò +3', lowHpStr: 3 },
      penNib: { name: 'ÌéúÏ¥â', emoji: '‚úíÔ∏è', desc: '10Î≤àÏß∏ Í≥µÍ≤© 2Î∞∞ Îç∞ÎØ∏ÏßÄ', attackCount: 0, doubleEvery: 10 },
      happyFlower: { name: 'ÌñâÎ≥µÌïú ÍΩÉ', emoji: 'üå∏', desc: '3ÌÑ¥ÎßàÎã§ ÏóêÎÑàÏßÄ +1', turnCount: 0, energyEvery: 3 },
      meatOnBone: { name: 'ÎºàÏóê Î∂ôÏùÄ Í≥†Í∏∞', emoji: 'üçñ', desc: 'Ï†ÑÌà¨ Ï¢ÖÎ£åÏãú HP 50% Ïù¥ÌïòÎ©¥ 12 ÌöåÎ≥µ', lowHpHeal: 12 },
      torii: { name: 'ÌÜ†Î¶¨Ïù¥', emoji: '‚õ©Ô∏è', desc: '5 Ïù¥Ìïò Îç∞ÎØ∏ÏßÄÎ•º 1Î°ú Í∞êÏÜå', reduceLowDmg: true },
      paperFrog: { name: 'Ï¢ÖÏù¥ Í∞úÍµ¨Î¶¨', emoji: 'üê∏', desc: 'Ï∑®ÏïΩ Ï†ÅÏóêÍ≤å +75% ÎéÄ (Í∏∞Î≥∏ 50%)', vulnBonus: 0.25 },
      orichalcum: { name: 'Ïò§Î¶¨ÌïòÎ•¥ÏΩò', emoji: 'üõ°Ô∏è', desc: 'ÌÑ¥ Ï¢ÖÎ£åÏãú Î∞©Ïñ¥ 0Ïù¥Î©¥ 6 Î∞©Ïñ¥', noBlockGain: 6 },
    };

    // ========== Ìè¨ÏÖò Îç∞Ïù¥ÌÑ∞ ==========
    const POTIONS = {
      fire: { name: 'ÌôîÏóº Ìè¨ÏÖò', emoji: 'üî•', desc: 'Ï†Å ÌïòÎÇòÏóêÍ≤å 20 Îç∞ÎØ∏ÏßÄ', dmg: 20 },
      block: { name: 'Î∞©Ïñ¥ Ìè¨ÏÖò', emoji: 'üõ°Ô∏è', desc: 'Î∞©Ïñ¥ÎèÑ 12 ÌöçÎìù', block: 12 },
      health: { name: 'Í≥ºÏùº Ï£ºÏä§', emoji: 'üßÉ', desc: 'Ï≤¥Î†• 20% ÌöåÎ≥µ', healPct: 0.2 },
      str: { name: 'Ìûò Ìè¨ÏÖò', emoji: 'üí™', desc: 'Ïù¥Î≤à Ï†ÑÌà¨ Ìûò +2', str: 2 },
      speed: { name: 'ÏÜçÎèÑ Ìè¨ÏÖò', emoji: 'üí®', desc: 'Ïù¥Î≤à ÌÑ¥ ÎØºÏ≤© +5', dex: 5 },
      weak: { name: 'Í≥µÌè¨ Ìè¨ÏÖò', emoji: 'üò±', desc: 'Ï†Å Ï†ÑÏ≤¥Ïóê ÏïΩÌôî 3', weakAll: 3 },
      poison: { name: 'ÎèÖ Ìè¨ÏÖò', emoji: '‚ò†Ô∏è', desc: 'Ï†Å ÌïòÎÇòÏóê ÎèÖ 6', poison: 6 },
      ancient: { name: 'Í≥†ÎåÄ Ìè¨ÏÖò', emoji: 'üè∫', desc: 'ÎûúÎç§ ÌååÏõå 1Í∞ú ÌöçÎìù', randomPower: true },
      energy: { name: 'ÏóêÎÑàÏßÄ Ìè¨ÏÖò', emoji: '‚ö°', desc: 'ÏóêÎÑàÏßÄ +2', energy: 2 },
    };

    // ========== Ïù¥Î≤§Ìä∏ Îç∞Ïù¥ÌÑ∞ ==========
    const EVENTS = [
      {
        id: 'bigFish', title: 'ÌÅ∞ Î¨ºÍ≥†Í∏∞', emoji: 'üêü',
        desc: 'Í±∞ÎåÄÌïú Ìô©Í∏àÎπõ Î¨ºÍ≥†Í∏∞Í∞Ä Î¨º ÏúÑÎ°ú ÏÜüÏïÑÏò¨ÎûêÏäµÎãàÎã§.',
        choices: [
          { text: 'üçñ Î∞îÎÇòÎÇò Î®πÍ∏∞ (HP 33% ÌöåÎ≥µ)', healPct: 0.33 },
          { text: 'üêü ÎèÑÎÑõ Î®πÍ∏∞ (ÏµúÎåÄHP +5)', maxHp: 5 },
          { text: 'üì¶ ÏÉÅÏûê Ïó¥Í∏∞ (Î†êÎ¶≠ ÌöçÎìù, HP -10)', relic: true, damage: 10 }
        ]
      },
      {
        id: 'goldenIdol', title: 'Ìô©Í∏à Ïö∞ÏÉÅ', emoji: 'üóø',
        desc: 'Ìô©Í∏à Ïö∞ÏÉÅÏù¥ Ï†úÎã® ÏúÑÏóêÏÑú ÎπõÎÇòÍ≥† ÏûàÏäµÎãàÎã§.',
        choices: [
          { text: 'üí∞ Í∞ÄÏ†∏Í∞ÑÎã§ (Í∏àÌôî +250, Ï†ÄÏ£º ÌöçÎìù)', gold: 250, curse: true },
          { text: 'üö∂ ÏßÄÎÇòÍ∞ÑÎã§' }
        ]
      },
      {
        id: 'neow', title: 'Ïã†ÎπÑÎ°úÏö¥ Ï°¥Ïû¨', emoji: 'üëÅÔ∏è',
        desc: 'Í∏∞Ïù¥Ìïú Ï°¥Ïû¨Í∞Ä ÏÑ†ÌÉùÏùÑ Ï†úÏïàÌï©ÎãàÎã§.',
        choices: [
          { text: 'üí™ ÌûòÏùÑ ÏõêÌïúÎã§ (Ìûò Î†êÎ¶≠ ÌöçÎìù)', relicKey: 'vajra' },
          { text: '‚ù§Ô∏è ÏÉùÎ™ÖÏùÑ ÏõêÌïúÎã§ (ÏµúÎåÄHP +8)', maxHp: 8 },
          { text: 'üí∞ Î∂ÄÎ•º ÏõêÌïúÎã§ (Í∏àÌôî +100)', gold: 100 }
        ]
      },
      {
        id: 'shrine', title: 'ÏûäÌòÄÏßÑ Ïã†Ï†Ñ', emoji: '‚õ™',
        desc: 'Í≥†ÎåÄÏùò Ïã†Ï†ÑÏù¥ ÎãπÏã†ÏùÑ Î∂ÄÎ¶ÖÎãàÎã§.',
        choices: [
          { text: 'üôè Í∏∞ÎèÑÌïúÎã§ (Ïπ¥Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú)', upgradeRandom: true },
          { text: 'üî• Î∂àÌÉúÏö¥Îã§ (Ïπ¥Îìú Ï†úÍ±∞)', removeRandom: true },
          { text: 'üö∂ ÏßÄÎÇòÍ∞ÑÎã§' }
        ]
      },
      {
        id: 'treasure', title: 'Î≥¥Î¨ºÏÉÅÏûê', emoji: 'üì¶',
        desc: 'Î®ºÏßÄ ÏåìÏù∏ Î≥¥Î¨ºÏÉÅÏûêÍ∞Ä ÏûàÏäµÎãàÎã§.',
        choices: [
          { text: 'üì¶ Ïó∞Îã§ (Î†êÎ¶≠ ÌöçÎìù)', relic: true },
          { text: 'üí∞ Î∂ÄÏàúÎã§ (Í∏àÌôî +50)', gold: 50 }
        ]
      },
      {
        id: 'vampire', title: 'Î±ÄÌååÏù¥Ïñ¥', emoji: 'üßõ',
        desc: 'Î±ÄÌååÏù¥Ïñ¥Í∞Ä Í±∞ÎûòÎ•º Ï†úÏïàÌï©ÎãàÎã§.',
        choices: [
          { text: 'ü©∏ ÌîºÎ•º Ï§ÄÎã§ (ÏµúÎåÄHP -5, Ìù¨Í∑Ä Î†êÎ¶≠)', maxHpLoss: 5, rareRelic: true },
          { text: '‚öîÔ∏è Ïã∏Ïö¥Îã§ (ÏóòÎ¶¨Ìä∏ Ï†ÑÌà¨)', combat: 'elite' },
          { text: 'üö∂ Í±∞Ï†àÌïúÎã§' }
        ]
      },
      {
        id: 'wheelOfChange', title: 'Ïö¥Î™ÖÏùò ÏàòÎ†àÎ∞îÌÄ¥', emoji: 'üé°',
        desc: 'Í±∞ÎåÄÌïú ÏàòÎ†àÎ∞îÌÄ¥Í∞Ä ÎèåÏïÑÍ∞ëÎãàÎã§.',
        choices: [
          { text: 'üé∞ ÎèåÎ¶∞Îã§ (ÎûúÎç§ Ìö®Í≥º)', randomWheel: true }
        ]
      }
    ];

    const NODE_ICONS = { start: 'üè†', enemy: 'üëπ', elite: 'üíÄ', boss: 'üëë', event: '‚ùì', rest: 'üî•', shop: 'üõí', treasure: 'üíé' };
    const NODE_NAMES = { start: 'ÏãúÏûë', enemy: 'Ï†Å', elite: 'ÏóòÎ¶¨Ìä∏', boss: 'Î≥¥Ïä§', event: 'Ïù¥Î≤§Ìä∏', rest: 'Ìú¥Ïãù', shop: 'ÏÉÅÏ†ê', treasure: 'Î≥¥Î¨º' };

    // ========== Í≤åÏûÑ ÏÉÅÌÉú ==========
    let state = 'menu', floor = 1, gold = 99;
    let hp = 80, maxHp = 80, block = 0, energy = 3, maxEnergy = 3;
    let strength = 0, dexterity = 0, weak = 0, vulnerable = 0, poison = 0;
    let deck = [], hand = [], drawPile = [], discardPile = [], exhaustPile = [];
    let relics = [], potions = [];
    let enemies = [], turn = 1, powers = {};
    let mapNodes = [], currentNode = null, visitedNodes = [];
    let animating = false, aiMsg = '', gameMsg = '';
    let currentEvent = null, shopItems = null;
    let rewardGold = 0, rewardCards = [], rewardPotion = null, rewardRelic = null;
    let combatLogs = [], selectedCardIndex = -1, targetMode = false;
    let cantDrawThisTurn = false, firstTurn = true;
    let attackCounter = 0;

    // ========== Ïú†Ìã∏ ==========
    const $ = id => document.getElementById(id);
    const rand = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
    const uid = () => Date.now() + '-' + Math.random().toString(36).slice(2, 7);
    const createCard = (key, upgraded = false) => {
      const base = CARDS[key];
      const card = { ...base, key, uid: uid(), upgraded };
      if (upgraded) {
        if (base.upgradedName) card.name = base.upgradedName;
        if (base.upgradedCost !== undefined) card.cost = base.upgradedCost;
        if (base.upgradedDamage !== undefined) card.damage = base.upgradedDamage;
        if (base.upgradedBlock !== undefined) card.block = base.upgradedBlock;
        if (base.upgradedDraw !== undefined) card.draw = base.upgradedDraw;
        if (base.upgradedDesc) card.desc = base.upgradedDesc;
        if (base.upgradedStrength !== undefined) card.strength = base.upgradedStrength;
        if (base.upgradedEndBlock !== undefined) card.endBlock = base.upgradedEndBlock;
        if (base.upgradedStrPerTurn !== undefined) card.strPerTurn = base.upgradedStrPerTurn;
        if (base.upgradedVulnerable !== undefined) card.vulnerable = base.upgradedVulnerable;
        if (base.upgradedWeak !== undefined) card.weak = base.upgradedWeak;
        if (base.upgradedStrMult !== undefined) card.strMult = base.upgradedStrMult;
        if (base.upgradedGainEnergy !== undefined) card.gainEnergy = base.upgradedGainEnergy;
        if (base.upgradedBlockOnAttack !== undefined) card.blockOnAttack = base.upgradedBlockOnAttack;
        if (base.upgradedDamageOnBlock !== undefined) card.damageOnBlock = base.upgradedDamageOnBlock;
        if (base.upgradedUpgradeAll) card.upgradeAll = true;
      }
      return card;
    };

    function upgradeCard(card) {
      if (card.upgraded) return card;
      const base = CARDS[card.key];
      card.upgraded = true;
      if (base.upgradedName) card.name = base.upgradedName;
      if (base.upgradedCost !== undefined) card.cost = base.upgradedCost;
      if (base.upgradedDamage !== undefined) card.damage = base.upgradedDamage;
      if (base.upgradedBlock !== undefined) card.block = base.upgradedBlock;
      if (base.upgradedDraw !== undefined) card.draw = base.upgradedDraw;
      if (base.upgradedDesc) card.desc = base.upgradedDesc;
      if (base.upgradedStrength !== undefined) card.strength = base.upgradedStrength;
      if (base.upgradedEndBlock !== undefined) card.endBlock = base.upgradedEndBlock;
      if (base.upgradedStrPerTurn !== undefined) card.strPerTurn = base.upgradedStrPerTurn;
      if (base.upgradedVulnerable !== undefined) card.vulnerable = base.upgradedVulnerable;
      if (base.upgradedWeak !== undefined) card.weak = base.upgradedWeak;
      if (base.upgradedStrMult !== undefined) card.strMult = base.upgradedStrMult;
      if (base.upgradedGainEnergy !== undefined) card.gainEnergy = base.upgradedGainEnergy;
      if (base.upgradedBlockOnAttack !== undefined) card.blockOnAttack = base.upgradedBlockOnAttack;
      if (base.upgradedDamageOnBlock !== undefined) card.damageOnBlock = base.upgradedDamageOnBlock;
      if (base.upgradedUpgradeAll) card.upgradeAll = true;
      return card;
    }

    function addCombatLog(msg, type = '') {
      combatLogs.push({ msg, type });
      if (combatLogs.length > 20) combatLogs.shift();
    }

    // ========== Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ ==========
    const getSaveData = () => ({
      floor, gold, hp, maxHp, block, energy, maxEnergy, strength, dexterity, weak, vulnerable, poison,
      deck, hand, drawPile, discardPile, exhaustPile, relics, potions,
      enemies, turn, powers, mapNodes, currentNode, visitedNodes, state,
      currentEvent, shopItems, rewardGold, rewardCards, rewardPotion, rewardRelic,
      attackCounter,
      savedAt: new Date().toLocaleString('ko-KR')
    });

    const loadSaveData = (d) => {
      floor = d.floor; gold = d.gold; hp = d.hp; maxHp = d.maxHp; block = d.block || 0;
      energy = d.energy; maxEnergy = d.maxEnergy; strength = d.strength || 0;
      dexterity = d.dexterity || 0; weak = d.weak || 0; vulnerable = d.vulnerable || 0;
      poison = d.poison || 0;
      deck = d.deck || []; hand = d.hand || []; drawPile = d.drawPile || [];
      discardPile = d.discardPile || []; exhaustPile = d.exhaustPile || [];
      relics = d.relics || []; potions = d.potions || [];
      enemies = d.enemies || []; turn = d.turn || 1; powers = d.powers || {};
      mapNodes = d.mapNodes || []; currentNode = d.currentNode; visitedNodes = d.visitedNodes || [];
      state = d.state || 'map';
      currentEvent = d.currentEvent || null;
      shopItems = d.shopItems || null;
      rewardGold = d.rewardGold || 0;
      rewardCards = d.rewardCards || [];
      rewardPotion = d.rewardPotion || null;
      rewardRelic = d.rewardRelic || null;
      attackCounter = d.attackCounter || 0;
    };

    const save = (i) => {
      const d = getSaveData();
      localStorage.setItem('slayv2-' + i, JSON.stringify(d));
      $('saveMsg').textContent = 'Ï†ÄÏû• ÏôÑÎ£å!';
      setTimeout(() => $('saveMsg').textContent = '', 2000);
      renderSaveSlots();
    };

    const load = (i) => {
      const raw = localStorage.getItem('slayv2-' + i);
      if (!raw) return;
      loadSaveData(JSON.parse(raw));
      closeSaveMenu();
      aiMsg = 'Î™®ÌóòÏùÑ Í≥ÑÏÜçÌï©ÎãàÎã§...';
      render();
    };

    const autoSave = () => {
      const d = getSaveData();
      d.savedAt += ' (ÏûêÎèô)';
      localStorage.setItem('slayv2-auto', JSON.stringify(d));
    };

    const loadAutoSave = () => {
      const raw = localStorage.getItem('slayv2-auto');
      if (!raw) return;
      loadSaveData(JSON.parse(raw));
      aiMsg = 'Ïù¥Ï†Ñ Î™®ÌóòÏùÑ Ïù¥Ïñ¥Í∞ëÎãàÎã§...';
      render();
    };

    const delSave = (i) => { localStorage.removeItem('slayv2-' + i); renderSaveSlots(); };

    // ========== Î†åÎçîÎßÅ ==========
    function render() {
      ['menuScreen', 'mapScreen', 'combatScreen', 'rewardScreen', 'eventScreen', 'restScreen', 'shopScreen', 'victoryScreen', 'defeatScreen'].forEach(id => $(id).classList.add('hidden'));
      $('topBar').classList.toggle('hidden', state === 'menu');

      if (state === 'menu') {
        $('menuScreen').classList.remove('hidden');
        $('continueBtn').classList.toggle('hidden', !localStorage.getItem('slayv2-auto'));
      } else if (state === 'map') {
        $('mapScreen').classList.remove('hidden');
        renderMapScreen();
      } else if (state === 'combat') {
        $('combatScreen').classList.remove('hidden');
        renderCombat();
      } else if (state === 'reward') {
        $('rewardScreen').classList.remove('hidden');
        renderReward();
      } else if (state === 'event') {
        $('eventScreen').classList.remove('hidden');
        renderEvent();
      } else if (state === 'rest') {
        $('restScreen').classList.remove('hidden');
        renderRest();
      } else if (state === 'shop') {
        $('shopScreen').classList.remove('hidden');
        renderShop();
      } else if (state === 'victory') {
        $('victoryScreen').classList.remove('hidden');
        $('victoryStats').innerHTML = `ÎèÑÎã¨ Ï∏µÏàò: ${floor}<br>ÎÇ®ÏùÄ HP: ${hp}/${maxHp}<br>Î≥¥Ïú† Í∏àÌôî: ${gold}<br>Î†êÎ¶≠: ${relics.length}Í∞ú<br>Îç±: ${deck.length}Ïû•<br>Ï¥ù Í≥µÍ≤© ÌöüÏàò: ${attackCounter}`;
      } else if (state === 'defeat') {
        $('defeatScreen').classList.remove('hidden');
        $('defeatSub').textContent = `${floor}Ï∏µÏóêÏÑú Ïì∞Îü¨Ï°åÏäµÎãàÎã§`;
        $('defeatStats').innerHTML = `HP: ${hp}/${maxHp}<br>Í∏àÌôî: ${gold}<br>Î†êÎ¶≠: ${relics.length}Í∞ú<br>Îç±: ${deck.length}Ïû•`;
      }

      $('floorNum').textContent = floor;
      $('hpText').textContent = `${hp}/${maxHp}`;
      $('goldText').textContent = gold;
      renderInventory();
    }

    function renderInventory() {
      let potionHtml = '';
      for (let i = 0; i < 3; i++) {
        const p = potions[i];
        potionHtml += `<div class="inv-slot" onclick="showPotionInfo(${i})" title="${p ? p.name + ': ' + p.desc : 'Îπà Ïä¨Î°Ø'}">${p ? p.emoji : '‚óã'}</div>`;
      }
      $('potionSlots').innerHTML = potionHtml;
      $('relicSlots').innerHTML = relics.slice(0, 5).map((r, i) => `<div class="inv-slot" onclick="showRelicInfo(${i})" title="${r.name}: ${r.desc}">${r.emoji}</div>`).join('');
    }

    function renderMapScreen() {
      $('mapAiMsg').querySelector('p').textContent = aiMsg ? `"${aiMsg}"` : '';
      $('mapAiMsg').classList.toggle('hidden', !aiMsg);
      $('mapMsg').textContent = gameMsg;

      const nextRow = currentNode ? mapNodes[currentNode.row + 1] : mapNodes[0];
      const nodes = nextRow ? nextRow.filter(n => isAccessible(n)) : [];
      $('quickSelect').innerHTML = nodes.map(n => `<button class="quick-btn" onclick="selectNode('${n.id}')" title="${NODE_NAMES[n.type]}">${NODE_ICONS[n.type]}</button>`).join('');
    }

    function renderCombat() {
      if (!enemies.length) return;
      
      $('combatAiMsg').querySelector('p').textContent = aiMsg ? `"${aiMsg}"` : '';
      $('combatAiMsg').classList.toggle('hidden', !aiMsg);
      $('combatMsg').textContent = gameMsg;

      // Ï†Å Î†åÎçîÎßÅ
      let enemyHtml = '';
      enemies.forEach((e, idx) => {
        if (e.hp <= 0) return;
        
        let st = '';
        if (e.block > 0) st += `<span class="status block">üõ°Ô∏è${e.block}</span>`;
        if (e.strength > 0) st += `<span class="status str">‚öîÔ∏è+${e.strength}</span>`;
        if (e.vulnerable > 0) st += `<span class="status vuln">Ï∑®ÏïΩ${e.vulnerable}</span>`;
        if (e.weak > 0) st += `<span class="status weak">ÏïΩÌôî${e.weak}</span>`;
        if (e.ritual > 0) st += `<span class="status ritual">ÏùòÏãù${e.ritual}</span>`;
        if (e.poison > 0) st += `<span class="status poison">ÎèÖ${e.poison}</span>`;

        let intentHtml = '';
        const intent = e.intent;
        if (intent) {
          if (intent.dmg !== undefined) {
            let dmg = intent.dmg + (e.strength || 0);
            if (e.weak > 0) dmg = Math.floor(dmg * 0.75);
            const times = intent.times || 1;
            const totalDmg = dmg * times;
            intentHtml = `<span class="red">‚öîÔ∏è ${totalDmg}${times > 1 ? ` (${dmg}√ó${times})` : ''}</span>`;
          } else if (intent.block) {
            intentHtml = `<span class="blue">üõ°Ô∏è Î∞©Ïñ¥</span>`;
          } else if (intent.debuff) {
            intentHtml = `<span class="purple">üíÄ ÎîîÎ≤ÑÌîÑ</span>`;
          } else {
            intentHtml = `<span class="gold">‚ú® Î≤ÑÌîÑ</span>`;
          }
        }

        enemyHtml += `
          <div class="enemy-unit" onclick="targetEnemy(${idx})">
            ${targetMode ? '<div class="target-indicator">‚¨áÔ∏è</div>' : ''}
            <div class="enemy-emoji" id="enemy-${idx}">${e.emoji}</div>
            <div class="enemy-name">${e.name}</div>
            <div class="hp-bar"><div class="hp-fill" style="width:${Math.max(0, e.hp / e.maxHp * 100)}%"></div></div>
            <div class="muted" style="font-size:12px;"><span class="red">${Math.max(0, e.hp)}</span> / ${e.maxHp}</div>
            <div>${st}</div>
            <div class="intent">${intentHtml}</div>
          </div>
        `;
      });
      $('enemyContainer').innerHTML = enemyHtml;

      // ÌîåÎ†àÏù¥Ïñ¥ ÏÉÅÌÉú
      $('playerHp').textContent = `${hp}/${maxHp}`;
      $('playerBlock').style.display = block > 0 ? 'flex' : 'none';
      $('playerBlock').querySelector('span:last-child').textContent = block;
      $('playerStr').style.display = strength > 0 ? 'inline-block' : 'none';
      $('playerStr').textContent = `‚öîÔ∏è+${strength}`;
      $('playerDex').style.display = dexterity > 0 ? 'inline-block' : 'none';
      $('playerDex').textContent = `üõ°Ô∏è+${dexterity}`;
      $('playerWeak').style.display = weak > 0 ? 'inline-block' : 'none';
      $('playerWeak').textContent = `ÏïΩÌôî${weak}`;
      $('playerVuln').style.display = vulnerable > 0 ? 'inline-block' : 'none';
      $('playerVuln').textContent = `Ï∑®ÏïΩ${vulnerable}`;
      $('playerPoison').style.display = poison > 0 ? 'inline-block' : 'none';
      $('playerPoison').textContent = `ÎèÖ${poison}`;

      // ÏóêÎÑàÏßÄ Ïò§Î∏å
      let orbs = '';
      for (let i = 0; i < maxEnergy; i++) {
        orbs += `<div class="orb ${i < energy ? 'active' : 'empty'}">${i < energy ? '‚ö°' : ''}</div>`;
      }
      $('energyOrbs').innerHTML = orbs;

      // Îç± Ïπ¥Ïö¥Ìä∏
      $('drawCount').textContent = drawPile.length;
      $('discardCount').textContent = discardPile.length;
      $('exhaustCount').textContent = exhaustPile.length;

      // ÏÜêÌå®
      $('handArea').innerHTML = hand.map((c, i) => cardHtml(c, i, c.cost > energy)).join('');
      $('endTurnBtn').disabled = animating;

      // Ï†ÑÌà¨ Î°úÍ∑∏
      let logHtml = '';
      combatLogs.slice(-5).forEach(l => {
        logHtml += `<p class="${l.type}">${l.msg}</p>`;
      });
      $('combatLog').innerHTML = logHtml;
    }

    function cardHtml(c, i, dis) {
      const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
      const upgradedClass = c.upgraded ? 'upgraded' : '';
      return `<div class="game-card ${c.type} ${upgradedClass} ${dis ? 'disabled' : ''}" onclick="playCard(${i})">
        <div class="card-cost">${c.cost}</div>
        ${c.upgraded ? '<div class="card-upgrade-badge">+</div>' : ''}
        <div class="card-icon">${icon}</div>
        <div class="card-name">${c.name}</div>
        <div class="card-desc">${c.desc}</div>
      </div>`;
    }

    function renderReward() {
      let html = '';
      if (rewardGold > 0) html += `<button class="choice-btn" onclick="collectGold()">üí∞ Í∏àÌôî ${rewardGold}Í∞ú ÌöçÎìù</button>`;
      if (rewardPotion) html += `<button class="choice-btn" onclick="collectPotion()" ${potions.length >= 3 ? 'disabled' : ''}>${rewardPotion.emoji} ${rewardPotion.name} ${potions.length >= 3 ? '(Í∞ÄÎìùÏ∞∏)' : ''}</button>`;
      if (rewardRelic) html += `<button class="choice-btn" onclick="collectRelic()">${rewardRelic.emoji} ${rewardRelic.name} (${rewardRelic.desc})</button>`;
      if (rewardCards.length > 0) {
        html += `<p class="muted" style="margin:12px 0 8px;">Ïπ¥Îìú ÏÑ†ÌÉù (1Ïû•)</p><div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">`;
        rewardCards.forEach((c, i) => {
          const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
          html += `<div class="game-card ${c.type}" onclick="selectRewardCard(${i})">
            <div class="card-cost">${c.cost}</div>
            <div class="card-icon">${icon}</div>
            <div class="card-name">${c.name}</div>
            <div class="card-desc">${c.desc}</div>
          </div>`;
        });
        html += `</div><button class="btn btn-dark btn-sm" style="margin-top:12px;" onclick="skipRewardCard()">Í±¥ÎÑàÎõ∞Í∏∞</button>`;
      }
      if (!rewardGold && !rewardPotion && !rewardRelic && !rewardCards.length) {
        html += `<button class="btn btn-gold" onclick="finishReward()">Í≥ÑÏÜçÌïòÍ∏∞</button>`;
      }
      $('rewardContent').innerHTML = html;
    }

    function renderEvent() {
      if (!currentEvent) return;
      let html = `<div class="event-emoji">${currentEvent.emoji}</div>
        <div class="event-title">${currentEvent.title}</div>
        <div class="event-desc">${currentEvent.desc}</div>`;
      currentEvent.choices.forEach((c, i) => {
        let disabled = '';
        if (c.damage && hp <= c.damage) disabled = 'disabled';
        if (c.maxHpLoss && maxHp <= c.maxHpLoss + 10) disabled = 'disabled';
        html += `<button class="choice-btn" onclick="chooseEvent(${i})" ${disabled}>${c.text}</button>`;
      });
      $('eventBox').innerHTML = html;
    }

    function renderRest() {
      let html = `<div class="event-emoji">üî•</div>
        <div class="event-title">Î™®Îã•Î∂à</div>
        <div class="event-desc">Îî∞ÎúªÌïú Î™®Îã•Î∂à ÏïûÏóêÏÑú Ïâ¨Ïñ¥Í∞ëÎãàÎã§.</div>
        <button class="choice-btn" onclick="restHeal()">üò¥ Ìú¥Ïãù (HP 30% ÌöåÎ≥µ)</button>
        <button class="choice-btn" onclick="restUpgrade()">‚¨ÜÔ∏è ÎåÄÏû•Ïû•Ïù¥ (Ïπ¥Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú)</button>`;
      $('restBox').innerHTML = html;
    }

    function renderShop() {
      $('shopGold').textContent = gold;
      $('shopAiMsg').querySelector('p').textContent = aiMsg ? `"${aiMsg}"` : '';
      $('shopMsg').textContent = gameMsg;

      if (!shopItems) return;
      let html = '';
      
      // ÏÑúÎπÑÏä§
      html += `<div class="shop-section"><div class="shop-title">ÏÑúÎπÑÏä§</div>`;
      html += `<div class="shop-service ${shopItems.removeUsed ? 'sold' : ''}" onclick="shopRemoveCard()">
        <span>üóëÔ∏è Ïπ¥Îìú Ï†úÍ±∞</span>
        <span class="gold">üí∞ ${shopItems.removePrice}</span>
      </div></div>`;

      // Ïπ¥Îìú
      html += `<div class="shop-section"><div class="shop-title">Ïπ¥Îìú</div><div class="shop-items">`;
      shopItems.cards.forEach((it, i) => {
        const c = it.item;
        const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
        html += `<div class="shop-item ${it.sold ? 'sold' : ''}" onclick="buyCard(${i})">
          <div class="game-card small ${c.type}">
            <div class="card-cost">${c.cost}</div>
            <div class="card-icon">${icon}</div>
            <div class="card-name">${c.name}</div>
            <div class="card-desc">${c.desc}</div>
          </div>
          <div class="shop-price">üí∞ ${it.price}</div>
        </div>`;
      });
      html += `</div></div>`;

      // Ìè¨ÏÖò
      html += `<div class="shop-section"><div class="shop-title">Ìè¨ÏÖò</div><div class="shop-items">`;
      shopItems.potions.forEach((it, i) => {
        html += `<div class="shop-item ${it.sold ? 'sold' : ''}" onclick="buyPotion(${i})" style="min-width:100px;text-align:center;">
          <div style="font-size:26px;">${it.item.emoji}</div>
          <div style="font-size:12px;">${it.item.name}</div>
          <div class="shop-price">üí∞ ${it.price}</div>
        </div>`;
      });
      html += `</div></div>`;

      // Î†êÎ¶≠
      if (shopItems.relics && shopItems.relics.length > 0) {
        html += `<div class="shop-section"><div class="shop-title">Î†êÎ¶≠</div><div class="shop-items">`;
        shopItems.relics.forEach((it, i) => {
          html += `<div class="shop-item ${it.sold ? 'sold' : ''}" onclick="buyRelic(${i})" style="min-width:100px;text-align:center;">
            <div style="font-size:30px;">${it.item.emoji}</div>
            <div style="font-size:12px;">${it.item.name}</div>
            <div style="font-size:10px;color:#888;">${it.item.desc}</div>
            <div class="shop-price">üí∞ ${it.price}</div>
          </div>`;
        });
        html += `</div></div>`;
      }

      $('shopContent').innerHTML = html;
    }

    function renderSaveSlots() {
      let html = '';
      for (let i = 0; i < 3; i++) {
        const raw = localStorage.getItem('slayv2-' + i);
        const d = raw ? JSON.parse(raw) : null;
        html += `<div class="save-slot">
          <div class="save-head"><span class="save-name">Ïä¨Î°Ø ${i + 1}</span>${d ? `<span class="save-date">${d.savedAt}</span>` : ''}</div>
          <div class="save-info">${d ? `${d.floor}Ï∏µ | HP: ${d.hp}/${d.maxHp} | üí∞${d.gold} | Îç±: ${d.deck.length}Ïû•` : 'ÎπÑÏñ¥ÏûàÏùå'}</div>
          <div class="save-btns">
            <button class="btn btn-dark" onclick="save(${i})" ${state === 'menu' ? 'disabled' : ''}>Ï†ÄÏû•</button>
            <button class="btn btn-dark" onclick="load(${i})" ${!d ? 'disabled' : ''}>Î∂àÎü¨Ïò§Í∏∞</button>
            ${d ? `<button class="btn btn-dark" style="flex:none;padding:10px 14px;" onclick="delSave(${i})">üóëÔ∏è</button>` : ''}
          </div>
        </div>`;
      }
      $('saveSlots').innerHTML = html;
    }

    // ========== Î™®Îã¨ ==========
    function showSaveMenu() { $('saveModal').classList.remove('hidden'); renderSaveSlots(); }
    function closeSaveMenu() { $('saveModal').classList.add('hidden'); }
    
    function showDeck() {
      $('deckModal').classList.remove('hidden');
      $('deckCount').textContent = deck.length;
      
      // ÌïÑÌÑ∞ Î≤ÑÌäº
      $('deckFilter').innerHTML = `
        <button class="active" onclick="filterDeck('all')">Ï†ÑÏ≤¥</button>
        <button onclick="filterDeck('attack')">Í≥µÍ≤©</button>
        <button onclick="filterDeck('skill')">Ïä§ÌÇ¨</button>
        <button onclick="filterDeck('power')">ÌååÏõå</button>
      `;
      
      renderDeckGrid('all');
    }
    
    function filterDeck(type) {
      document.querySelectorAll('.deck-filter button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderDeckGrid(type);
    }
    
    function renderDeckGrid(filter) {
      let cards = filter === 'all' ? deck : deck.filter(c => c.type === filter);
      cards = cards.sort((a, b) => a.cost - b.cost);
      
      let html = '';
      cards.forEach(c => {
        const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
        const upgradedClass = c.upgraded ? 'upgraded' : '';
        html += `<div class="game-card small ${c.type} ${upgradedClass}">
          <div class="card-cost">${c.cost}</div>
          ${c.upgraded ? '<div class="card-upgrade-badge">+</div>' : ''}
          <div class="card-icon">${icon}</div>
          <div class="card-name">${c.name}</div>
          <div class="card-desc">${c.desc}</div>
        </div>`;
      });
      $('deckGrid').innerHTML = html;
    }
    
    function closeDeck() { $('deckModal').classList.add('hidden'); }
    
    function showMap() {
      $('mapModal').classList.remove('hidden');
      $('mapLegend').innerHTML = Object.entries(NODE_ICONS).map(([k, v]) => `<span>${v} ${NODE_NAMES[k]}</span>`).join('');
      
      const boxWidth = 420;
      const floorHeight = 34;
      const nodeSize = 40;
      
      // ÎÖ∏Îìú ÏúÑÏπò Í≥ÑÏÇ∞
      const nodePositions = {};
      mapNodes.forEach((row, ri) => {
        row.forEach((n, ci) => {
          const numNodes = row.length;
          const spacing = boxWidth / (numNodes + 1);
          const x = spacing * (ci + 1);
          const y = (mapNodes.length - 1 - ri) * floorHeight + 25;
          nodePositions[n.id] = { x, y };
        });
      });
      
      // SVG Í≤ΩÎ°ú ÏÉùÏÑ±
      const svgHeight = mapNodes.length * floorHeight + 50;
      let pathsHtml = `<svg class="map-paths" width="${boxWidth}" height="${svgHeight}">`;
      
      mapNodes.forEach((row, ri) => {
        row.forEach(node => {
          const from = nodePositions[node.id];
          node.connections.forEach(connId => {
            const to = nodePositions[connId];
            if (from && to) {
              let pathClass = 'map-path';
              
              // Í≤ΩÎ°ú ÏÉÅÌÉú Í≤∞Ï†ï
              const isCurrentNode = currentNode && currentNode.id === node.id;
              const isVisitedPath = visitedNodes.includes(node.id) && visitedNodes.includes(connId);
              const isFromVisited = visitedNodes.includes(node.id);
              
              if (isVisitedPath) {
                pathClass += ' visited';
              } else if (isCurrentNode) {
                // ÌòÑÏû¨ ÎÖ∏ÎìúÏóêÏÑú ÎÇòÍ∞ÄÎäî Í≤ΩÎ°úÎäî ÏÑ†ÌÉù Í∞ÄÎä•
                pathClass += ' accessible';
              }
              
              // Í≥°ÏÑ† Í≤ΩÎ°ú (Î≤†ÏßÄÏñ¥ Ïª§Î∏å)
              const midY = (from.y + to.y) / 2;
              const ctrlX = (from.x + to.x) / 2;
              pathsHtml += `<path class="${pathClass}" d="M${from.x},${from.y} Q${ctrlX},${midY} ${to.x},${to.y}"/>`;
            }
          });
        });
      });
      
      pathsHtml += '</svg>';
      
      // ÎÖ∏Îìú HTML ÏÉùÏÑ± - Ï†àÎåÄ ÏúÑÏπò ÏÇ¨Ïö©
      let nodesHtml = `<div class="map-container" style="height:${svgHeight}px;">` + pathsHtml;
      
      mapNodes.forEach((row, ri) => {
        row.forEach(n => {
          const pos = nodePositions[n.id];
          let cls = 'map-node ';
          if (currentNode && currentNode.id === n.id) cls += 'current';
          else if (visitedNodes.includes(n.id)) cls += 'visited';
          else if (isAccessible(n)) cls += 'accessible';
          else cls += 'locked';
          
          nodesHtml += `<div class="${cls}" style="position:absolute;left:${pos.x}px;top:${pos.y}px;transform:translate(-50%,-50%);" onclick="selectNode('${n.id}')" title="${NODE_NAMES[n.type]}">${NODE_ICONS[n.type]}</div>`;
        });
      });
      
      nodesHtml += '</div>';
      
      $('mapBox').innerHTML = nodesHtml;
    }
    function closeMap() { $('mapModal').classList.add('hidden'); }

    function showUpgrade() {
      $('upgradeModal').classList.remove('hidden');
      const upgradeable = deck.filter(c => !c.upgraded);
      let html = '';
      upgradeable.forEach((c, i) => {
        const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
        const originalIdx = deck.indexOf(c);
        html += `<div class="game-card small ${c.type}" onclick="doUpgrade(${originalIdx})">
          <div class="card-cost">${c.cost}</div>
          <div class="card-icon">${icon}</div>
          <div class="card-name">${c.name}</div>
          <div class="card-desc">${c.desc}</div>
        </div>`;
      });
      if (!upgradeable.length) html = '<p class="muted center">ÏóÖÍ∑∏Î†àÏù¥ÎìúÌï† Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
      $('upgradeGrid').innerHTML = html;
    }
    function closeUpgrade() { $('upgradeModal').classList.add('hidden'); }
    
    function doUpgrade(idx) {
      upgradeCard(deck[idx]);
      closeUpgrade();
      gameMsg = `${deck[idx].name} ÏóÖÍ∑∏Î†àÏù¥Îìú!`;
      state = 'map';
      autoSave();
      render();
    }

    function showRemove() {
      $('removeModal').classList.remove('hidden');
      let html = '';
      deck.forEach((c, i) => {
        const icon = c.type === 'attack' ? '‚öîÔ∏è' : c.type === 'skill' ? 'üõ°Ô∏è' : '‚ú®';
        const upgradedClass = c.upgraded ? 'upgraded' : '';
        html += `<div class="game-card small ${c.type} ${upgradedClass}" onclick="doRemove(${i})">
          <div class="card-cost">${c.cost}</div>
          ${c.upgraded ? '<div class="card-upgrade-badge">+</div>' : ''}
          <div class="card-icon">${icon}</div>
          <div class="card-name">${c.name}</div>
          <div class="card-desc">${c.desc}</div>
        </div>`;
      });
      $('removeGrid').innerHTML = html;
    }
    function closeRemove() { $('removeModal').classList.add('hidden'); }
    
    function doRemove(idx) {
      const removed = deck.splice(idx, 1)[0];
      closeRemove();
      gameMsg = `${removed.name} Ï†úÍ±∞Îê®`;
      if (shopItems) shopItems.removeUsed = true;
      render();
    }

    // ========== Í≤åÏûÑ Î°úÏßÅ ==========
    function startGame() {
      deck = [
        ...Array(5).fill(null).map(() => createCard('strike')),
        ...Array(4).fill(null).map(() => createCard('defend')),
        createCard('bash')
      ];
      hp = 80; maxHp = 80; gold = 99; floor = 1;
      relics = [{ ...RELICS.blood, key: 'blood', uid: uid() }];
      potions = [];
      energy = 3; maxEnergy = 3; powers = {};
      strength = 0; dexterity = 0; weak = 0; vulnerable = 0; poison = 0;
      mapNodes = generateMap();
      combatLogs = []; attackCounter = 0;
      
      // ÏãúÏûë ÎÖ∏Îìú ÏûêÎèô Î∞©Î¨∏ Ï≤òÎ¶¨
      const startNode = mapNodes[0][0];
      currentNode = startNode;
      visitedNodes = [startNode.id];
      
      state = 'map'; aiMsg = 'Ï≤®ÌÉëÏóê Î∞úÏùÑ Îì§ÏòÄÏäµÎãàÎã§...'; gameMsg = '';
      render();
    }

    function generateMap() {
      const nodes = [];
      const numFloors = 15;
      const nodesPerFloor = [1, 3, 3, 4, 3, 4, 3, 4, 3, 4, 3, 3, 2, 1, 1];
      
      // ÎÖ∏Îìú ÏÉùÏÑ±
      for (let r = 0; r < numFloors; r++) {
        const row = [];
        const numNodes = nodesPerFloor[r];
        
        for (let c = 0; c < numNodes; c++) {
          let type = 'enemy';
          
          if (r === 0) type = 'start';
          else if (r === numFloors - 1) type = 'boss';
          else if (r === numFloors - 2) type = 'rest';  // Î≥¥Ïä§ Ï†Ñ Ìú¥Ïãù
          else if (r === 8) type = 'treasure';  // Ï§ëÍ∞Ñ Î≥¥Î¨º
          else {
            // Ï∏µÎ≥Ñ ÌôïÎ•† Ï°∞Ï†ï
            const x = Math.random();
            if (r <= 3) {
              // Ï¥àÎ∞ò: Ï†Å ÎßéÏùå
              if (x < 0.55) type = 'enemy';
              else if (x < 0.70) type = 'event';
              else if (x < 0.85) type = 'rest';
              else if (x < 0.95) type = 'shop';
              else type = 'elite';
            } else if (r <= 7) {
              // Ï§ëÎ∞ò: ÏóòÎ¶¨Ìä∏ Îì±Ïû•
              if (x < 0.45) type = 'enemy';
              else if (x < 0.58) type = 'event';
              else if (x < 0.70) type = 'rest';
              else if (x < 0.80) type = 'shop';
              else if (x < 0.92) type = 'elite';
              else type = 'treasure';
            } else {
              // ÌõÑÎ∞ò: Ìú¥Ïãù/ÏÉÅÏ†ê ÎßéÏùå
              if (x < 0.40) type = 'enemy';
              else if (x < 0.55) type = 'event';
              else if (x < 0.72) type = 'rest';
              else if (x < 0.85) type = 'shop';
              else type = 'elite';
            }
          }
          
          // x Ï¢åÌëú Í≥ÑÏÇ∞ (ÏãúÍ∞ÅÏ†Å Î∞∞ÏπòÏö©)
          const spacing = 100 / (numNodes + 1);
          const xPos = spacing * (c + 1);
          
          row.push({ 
            id: `${r}-${c}`, 
            row: r, 
            col: c, 
            type, 
            connections: [],
            x: xPos
          });
        }
        nodes.push(row);
      }
      
      // Slay the Spire Ïä§ÌÉÄÏùº Ïó∞Í≤∞ ÏÉùÏÑ±
      for (let r = 0; r < numFloors - 1; r++) {
        const currRow = nodes[r];
        const nextRow = nodes[r + 1];
        
        // 1Îã®Í≥Ñ: Í∞Å ÎÖ∏ÎìúÏóêÏÑú 1~2Í∞ú Ïó∞Í≤∞ ÏÉùÏÑ± (Í∞ÄÍπåÏö¥ ÎÖ∏Îìú Ïö∞ÏÑ†)
        currRow.forEach(node => {
          // Îã§Ïùå Ï∏µ ÎÖ∏ÎìúÎì§ÏùÑ Í±∞Î¶¨ÏàúÏúºÎ°ú Ï†ïÎ†¨
          const sortedNext = [...nextRow].sort((a, b) => {
            return Math.abs(a.x - node.x) - Math.abs(b.x - node.x);
          });
          
          // Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎÖ∏ÎìúÎäî Î∞òÎìúÏãú Ïó∞Í≤∞
          if (sortedNext.length > 0) {
            node.connections.push(sortedNext[0].id);
          }
          
          // Îëê Î≤àÏß∏Î°ú Í∞ÄÍπåÏö¥ ÎÖ∏ÎìúÎäî 60% ÌôïÎ•†Î°ú Ïó∞Í≤∞
          if (sortedNext.length > 1 && Math.random() < 0.6) {
            node.connections.push(sortedNext[1].id);
          }
          
          // ÏÑ∏ Î≤àÏß∏ ÎÖ∏ÎìúÎäî 20% ÌôïÎ•†Î°ú Ïó∞Í≤∞
          if (sortedNext.length > 2 && Math.random() < 0.2) {
            node.connections.push(sortedNext[2].id);
          }
        });
        
        // 2Îã®Í≥Ñ: Î™®Îì† Îã§Ïùå Ï∏µ ÎÖ∏ÎìúÍ∞Ä ÏµúÏÜå 1Í∞ú ÏßÑÏûÖ Í≤ΩÎ°ú Í∞ñÎèÑÎ°ù Î≥¥Ïû•
        nextRow.forEach(nextNode => {
          const hasIncoming = currRow.some(n => n.connections.includes(nextNode.id));
          if (!hasIncoming) {
            // Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ïù¥Ï†Ñ Ï∏µ ÎÖ∏ÎìúÏôÄ Ïó∞Í≤∞
            const closest = currRow.reduce((best, n) => {
              const dist = Math.abs(n.x - nextNode.x);
              return dist < best.dist ? { node: n, dist } : best;
            }, { node: currRow[0], dist: Infinity });
            closest.node.connections.push(nextNode.id);
          }
        });
      }
      
      // 3Îã®Í≥Ñ: Í≤ΩÎ°úÍ∞Ä ÍµêÏ∞®ÌïòÏßÄ ÏïäÎèÑÎ°ù Ï†ïÎ¶¨ (ÏÑ†ÌÉùÏ†Å)
      for (let r = 0; r < numFloors - 1; r++) {
        const currRow = nodes[r];
        currRow.forEach(node => {
          // Ï§ëÎ≥µ Ï†úÍ±∞
          node.connections = [...new Set(node.connections)];
        });
      }
      
      return nodes;
    }

    function isAccessible(n) {
      if (visitedNodes.includes(n.id)) return false;
      if (!currentNode) return n.row === 0;
      return currentNode.connections.includes(n.id);
    }

    function findNode(id) {
      for (let row of mapNodes) {
        for (let n of row) {
          if (n.id === id) return n;
        }
      }
      return null;
    }

    function selectNode(id) {
      // Ï†ÑÌà¨/Ïù¥Î≤§Ìä∏/ÏÉÅÏ†ê Îì± ÏßÑÌñâ Ï§ëÏóêÎäî Ïù¥Îèô Î∂àÍ∞Ä
      if (state === 'combat' || state === 'event' || state === 'rest' || state === 'shop' || state === 'reward') {
        gameMsg = 'ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Ïù¥Î≤§Ìä∏Î•º ÏôÑÎ£åÌïòÏÑ∏Ïöî';
        render();
        return;
      }
      
      const n = findNode(id);
      if (!n || !isAccessible(n)) { 
        gameMsg = 'Ïù¥ÎèôÌï† Ïàò ÏóÜÏäµÎãàÎã§'; 
        render(); 
        return; 
      }
      
      currentNode = n;
      visitedNodes.push(n.id);
      floor = n.row + 1;
      closeMap();
      gameMsg = ''; aiMsg = '';
      setTimeout(autoSave, 100);

      switch (n.type) {
        case 'start': state = 'map'; break;
        case 'enemy': startCombat('normal'); break;
        case 'elite': startCombat('elite'); break;
        case 'boss': startCombat('boss'); break;
        case 'event': triggerEvent(); break;
        case 'rest': triggerRest(); break;
        case 'shop': triggerShop(); break;
        case 'treasure': triggerTreasure(); break;
        default: state = 'map';
      }
      render();
    }

    function startCombat(type) {
      let pool, key;
      
      if (type === 'boss') {
        pool = ['slimeBoss', 'guardian', 'hexaghost'];
      } else if (type === 'elite') {
        pool = ['gremlinNob', 'lagavulin'];
      } else {
        pool = ['cultist', 'jawWorm', 'slimeM', 'looter'];
        // Í∞ÄÎÅî Ïä¨ÎùºÏûÑ 2ÎßàÎ¶¨
        if (Math.random() < 0.2) {
          pool = ['slimeS'];
        }
      }
      
      key = pool[rand(0, pool.length - 1)];
      const data = ENEMIES[key];
      
      enemies = [];
      const count = (key === 'slimeS' || key === 'sentries') ? (data.count || 2) : 1;
      
      for (let i = 0; i < count; i++) {
        const ehp = rand(data.hp[0], data.hp[1]);
        const e = {
          ...data, key, 
          hp: ehp, maxHp: ehp, 
          block: 0, strength: 0, ritual: 0, 
          weak: 0, vulnerable: 0, poison: 0,
          uid: uid()
        };
        e.intent = data.atks[rand(0, data.atks.length - 1)];
        enemies.push(e);
      }
      
      // Ï¥àÍ∏∞Ìôî
      turn = 1; block = 0; weak = 0; vulnerable = 0; poison = 0;
      dexterity = 0; powers = {}; exhaustPile = []; combatLogs = [];
      cantDrawThisTurn = false; firstTurn = true;
      
      // Î†êÎ¶≠ Ìö®Í≥º
      let bBlock = 0, bStr = 0, bEnergy = 0;
      relics.forEach(r => {
        if (r.startBlock) bBlock += r.startBlock;
        if (r.startStr) bStr += r.startStr;
        if (r.firstTurnEnergy && firstTurn) bEnergy += r.firstTurnEnergy;
        if (r.startVuln) enemies.forEach(e => e.vulnerable += r.startVuln);
        if (r.startVulnAll) enemies.forEach(e => e.vulnerable += r.startVulnAll);
      });
      
      // Îç± ÏÑûÍ∏∞ Î∞è ÎìúÎ°úÏö∞
      const shuffled = shuffle([...deck]);
      drawPile = shuffled.slice(5);
      hand = shuffled.slice(0, 5);
      discardPile = [];
      
      energy = maxEnergy + bEnergy;
      block = bBlock;
      strength = bStr;
      
      aiMsg = data.boss ? 'Í∞ïÎ†•Ìïú Ï†Å Ï∂úÌòÑ!' : data.elite ? 'ÏóòÎ¶¨Ìä∏ÏôÄ Ï°∞Ïö∞!' : 'Ï†ÅÍ≥º Ï°∞Ïö∞!';
      gameMsg = '';
      state = 'combat';
      
      addCombatLog(`${enemies.map(e => e.name).join(', ')}ÏôÄ(Í≥º) Ï†ÑÌà¨ ÏãúÏûë!`);
    }

    function targetEnemy(idx) {
      if (animating) return;
      if (!targetMode || selectedCardIndex < 0) return;
      targetMode = false;
      executeCard(selectedCardIndex, idx);
      selectedCardIndex = -1;
    }

    let lastPlayTime = 0;
    function playCard(i) {
      // Ïù¥Ï§ë ÌÅ¥Î¶≠ Î∞©ÏßÄ
      const now = Date.now();
      if (now - lastPlayTime < 500) return;
      lastPlayTime = now;
      
      if (animating || state !== 'combat') return;
      const c = hand[i];
      if (!c) return;
      if (c.cost > energy) { 
        gameMsg = 'ÏóêÎÑàÏßÄ Î∂ÄÏ°±!'; 
        render(); 
        return; 
      }

      // ÌÉÄÍ≤üÏù¥ ÌïÑÏöîÌïú Ïπ¥Îìú Ï≤òÎ¶¨
      const aliveEnemies = enemies.filter(e => e.hp > 0);
      if (c.type === 'attack' && !c.aoe && aliveEnemies.length > 1) {
        targetMode = true;
        selectedCardIndex = i;
        gameMsg = 'ÎåÄÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
        render();
        return;
      }
      
      executeCard(i, 0);
    }

    function executeCard(i, targetIdx) {
      if (animating) return;
      animating = true;
      
      const c = hand[i];
      if (!c) { animating = false; return; }
      
      energy -= c.cost;
      
      const e = enemies.filter(en => en.hp > 0)[targetIdx] || enemies.find(en => en.hp > 0);
      let msgs = [];

      // Í≥µÍ≤© Ïπ¥Îìú
      if (c.type === 'attack') {
        attackCounter++;
        
        // ÌéúÏ¥â Î†êÎ¶≠ ÌôïÏù∏
        let penNibBonus = 1;
        const penNib = relics.find(r => r.doubleEvery);
        if (penNib && attackCounter % penNib.doubleEvery === 0) {
          penNibBonus = 2;
          msgs.push('ÌéúÏ¥â Î∞úÎèô!');
        }
        
        // Îç∞ÎØ∏ÏßÄ Í≥ÑÏÇ∞
        let baseDmg = c.damage || 0;
        if (c.blockDamage) baseDmg = block; // Î™∏ÌÜµÎ∞ïÏπòÍ∏∞
        
        let strBonus = strength;
        if (c.strMult) strBonus = strength * c.strMult; // Ìó§ÎπÑÎ∏îÎ†àÏù¥Îìú
        
        let dmg = baseDmg + strBonus;
        if (weak > 0) dmg = Math.floor(dmg * 0.75);
        dmg *= penNibBonus;
        
        const times = c.times || 1;
        const targets = c.aoe ? enemies.filter(en => en.hp > 0) : [e];
        
        targets.forEach(target => {
          for (let t = 0; t < times; t++) {
            let finalDmg = dmg;
            
            // Ï∑®ÏïΩ Î≥¥ÎÑàÏä§ (Ï¢ÖÏù¥ Í∞úÍµ¨Î¶¨ Ìè¨Ìï®)
            if (target.vulnerable > 0) {
              let vulnMult = 1.5;
              const paperFrog = relics.find(r => r.vulnBonus);
              if (paperFrog) vulnMult += paperFrog.vulnBonus;
              finalDmg = Math.floor(finalDmg * vulnMult);
            }
            
            const absorbed = Math.min(finalDmg, target.block);
            target.block = Math.max(0, target.block - finalDmg);
            target.hp -= Math.max(0, finalDmg - absorbed);
            
            // Ï†Å ÌîºÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò
            const enemyEl = document.getElementById(`enemy-${enemies.indexOf(target)}`);
            if (enemyEl) {
              enemyEl.classList.add('hit');
              setTimeout(() => enemyEl.classList.remove('hit'), 300);
            }
          }
        });
        
        const totalDmg = dmg * times * targets.length;
        msgs.push(`${totalDmg} Îç∞ÎØ∏ÏßÄ`);
        addCombatLog(`${c.name} ‚Üí ${totalDmg} Îç∞ÎØ∏ÏßÄ`, 'dmg');
        
        // ÎîîÎ≤ÑÌîÑ Ï†ÅÏö©
        if (c.vulnerable) { e.vulnerable += c.vulnerable; msgs.push(`Ï∑®ÏïΩ${c.vulnerable}`); }
        if (c.weak) { e.weak += c.weak; msgs.push(`ÏïΩÌôî${c.weak}`); }
        
        // Î∂ÑÎÖ∏ (Í≥µÍ≤©Ïãú Î∞©Ïñ¥)
        if (powers.blockOnAttack) {
          gainBlock(powers.blockOnAttack);
          msgs.push(`Î∂ÑÎÖ∏Î°ú ${powers.blockOnAttack} Î∞©Ïñ¥`);
        }
      }
      
      // Î∞©Ïñ¥
      if (c.block) {
        gainBlock(c.block);
        msgs.push(`${c.block + dexterity} Î∞©Ïñ¥`);
        addCombatLog(`${c.name} ‚Üí ${c.block + dexterity} Î∞©Ïñ¥`, 'block');
      }
      
      // ÌååÏõå Ïπ¥Îìú
      if (c.type === 'power') {
        if (c.strength) { strength += c.strength; msgs.push(`Ìûò+${c.strength}`); }
        if (c.endBlock) { powers.metal = (powers.metal || 0) + c.endBlock; msgs.push(`Í∏àÏÜçÌôî ${c.endBlock}`); }
        if (c.strPerTurn) { powers.demon = (powers.demon || 0) + c.strPerTurn; msgs.push(`ÏïÖÎßàÌòïÏÉÅ`); }
        if (c.blockOnAttack) { powers.blockOnAttack = (powers.blockOnAttack || 0) + c.blockOnAttack; }
        if (c.damageOnBlock) { powers.damageOnBlock = (powers.damageOnBlock || 0) + c.damageOnBlock; }
        addCombatLog(`${c.name} Î∞úÎèô!`);
      }
      
      // ÎìúÎ°úÏö∞
      if (c.draw && !cantDrawThisTurn) {
        for (let d = 0; d < c.draw; d++) drawCard();
        msgs.push(`${c.draw} ÎìúÎ°úÏö∞`);
      }
      
      // ÏóêÎÑàÏßÄ ÌöçÎìù
      if (c.gainEnergy) {
        energy += c.gainEnergy;
        msgs.push(`ÏóêÎÑàÏßÄ+${c.gainEnergy}`);
      }
      
      // ÏûêÌï¥
      if (c.selfDamage) {
        hp -= c.selfDamage;
        msgs.push(`HP-${c.selfDamage}`);
      }
      
      // ÎìúÎ°úÏö∞ Î∂àÍ∞Ä
      if (c.cantDraw) {
        cantDrawThisTurn = true;
      }
      
      // Î¨¥Ïû• (ÏóÖÍ∑∏Î†àÏù¥Îìú)
      if (c.upgradeHand) {
        const upgradeable = hand.filter(card => !card.upgraded && card !== c);
        if (upgradeable.length > 0) {
          if (c.upgradeAll) {
            upgradeable.forEach(card => upgradeCard(card));
            msgs.push('ÏÜêÌå® Ï†ÑÏ≤¥ ÏóÖÍ∑∏Î†àÏù¥Îìú!');
          } else {
            upgradeCard(upgradeable[rand(0, upgradeable.length - 1)]);
            msgs.push('Ïπ¥Îìú 1Ïû• ÏóÖÍ∑∏Î†àÏù¥Îìú');
          }
        }
      }
      
      // Î∂ÑÎÖ∏ (Î≥µÏÇ¨Î≥∏)
      if (c.addCopy) {
        const copy = createCard(c.key, c.upgraded);
        discardPile.push(copy);
      }
      
      // ÏßÑÏ†ïÌïú Ìà¨ÏßÄ (ÎûúÎç§ ÏÜåÎ©∏)
      if (c.exhaustRandom && hand.length > 1) {
        const others = hand.filter((card, idx) => idx !== i);
        const toExhaust = others[rand(0, others.length - 1)];
        const exhaustIdx = hand.indexOf(toExhaust);
        hand.splice(exhaustIdx, 1);
        exhaustPile.push(toExhaust);
        msgs.push(`${toExhaust.name} ÏÜåÎ©∏`);
      }

      gameMsg = msgs.join(', ') + '!';

      // Ïπ¥Îìú Ï≤òÎ¶¨
      const played = hand.splice(i, 1)[0];
      if (c.exhaust) exhaustPile.push(played);
      else discardPile.push(played);

      render();
      
      setTimeout(() => {
        animating = false;
        checkEnemyDeath();
      }, 300);
    }

    function gainBlock(amount) {
      const total = amount + dexterity;
      block += total;
      
      // Ï†ÄÍ±∞ÎÑàÌä∏
      if (powers.damageOnBlock) {
        const target = enemies.find(e => e.hp > 0);
        if (target) {
          const dmg = powers.damageOnBlock;
          const absorbed = Math.min(dmg, target.block);
          target.block -= absorbed;
          target.hp -= (dmg - absorbed);
          addCombatLog(`Ï†ÄÍ±∞ÎÑàÌä∏ ‚Üí ${dmg} Îç∞ÎØ∏ÏßÄ`, 'dmg');
        }
      }
    }

    function drawCard() {
      if (cantDrawThisTurn) return;
      if (!drawPile.length && discardPile.length) {
        drawPile = shuffle(discardPile);
        discardPile = [];
      }
      if (drawPile.length && hand.length < 10) {
        hand.push(drawPile.pop());
      }
    }

    function checkEnemyDeath() {
      const allDead = enemies.every(e => e.hp <= 0);
      if (allDead) {
        combatVictory();
      } else if (hp <= 0) {
        defeat();
      } else {
        render();
      }
    }

    let lastEndTurnTime = 0;
    function endTurn() {
      const now = Date.now();
      if (now - lastEndTurnTime < 500) return;
      lastEndTurnTime = now;
      
      if (animating) return;
      animating = true;
      
      // Ïò§Î¶¨ÌïòÎ•¥ÏΩò Î†êÎ¶≠
      if (block === 0) {
        const ori = relics.find(r => r.noBlockGain);
        if (ori) {
          block += ori.noBlockGain;
          addCombatLog(`Ïò§Î¶¨ÌïòÎ•¥ÏΩò ‚Üí ${ori.noBlockGain} Î∞©Ïñ¥`, 'block');
        }
      }
      
      // Í∏àÏÜçÌôî
      if (powers.metal) {
        gainBlock(powers.metal);
        addCombatLog(`Í∏àÏÜçÌôî ‚Üí ${powers.metal} Î∞©Ïñ¥`, 'block');
      }
      
      render();

      // Ï†Å ÌÑ¥
      setTimeout(() => {
        executeEnemyTurns();
      }, 400);
    }

    function executeEnemyTurns() {
      let delay = 0;
      
      enemies.forEach((e, idx) => {
        if (e.hp <= 0) return;
        
        setTimeout(() => {
          const intent = e.intent;
          
          // ÎèÖ Îç∞ÎØ∏ÏßÄ
          if (e.poison > 0) {
            e.hp -= e.poison;
            e.poison -= 1;
            addCombatLog(`${e.name} ÎèÖ ‚Üí ${e.poison + 1} Îç∞ÎØ∏ÏßÄ`, 'dmg');
          }
          
          if (e.hp <= 0) {
            render();
            return;
          }
          
          if (intent.dmg !== undefined) {
            let dmg = intent.dmg + (e.strength || 0);
            if (e.weak > 0) dmg = Math.floor(dmg * 0.75);
            
            const times = intent.times || 1;
            let totalDmg = 0;
            let totalBlocked = 0;
            
            // ÌÜ†Î¶¨Ïù¥ Î†êÎ¶≠
            const torii = relics.find(r => r.reduceLowDmg);
            
            for (let t = 0; t < times; t++) {
              let hitDmg = dmg;
              if (vulnerable > 0) hitDmg = Math.floor(hitDmg * 1.5);
              
              // ÌÜ†Î¶¨Ïù¥
              if (torii && hitDmg <= 5 && hitDmg > 0) hitDmg = 1;
              
              const absorbed = Math.min(hitDmg, block);
              block -= absorbed;
              hp -= (hitDmg - absorbed);
              totalDmg += hitDmg;
              totalBlocked += absorbed;
            }
            
            gameMsg = `${e.name} Í≥µÍ≤©! ${totalDmg}${totalBlocked > 0 ? ` (${totalBlocked} Î∞©Ïñ¥)` : ''}`;
            addCombatLog(gameMsg, 'dmg');
          } else if (intent.block) {
            e.block += intent.block;
            if (intent.str) e.strength += intent.str;
            gameMsg = `${e.name}Ïù¥(Í∞Ä) Î∞©Ïñ¥!`;
            addCombatLog(gameMsg, 'block');
          } else if (intent.ritual) {
            e.ritual += intent.ritual;
            gameMsg = `${e.name} ÏùòÏãù! Ìûò+${intent.ritual}/ÌÑ¥`;
            addCombatLog(gameMsg);
          } else if (intent.str) {
            e.strength += intent.str;
            gameMsg = `${e.name} Í∞ïÌôî! Ìûò+${intent.str}`;
            addCombatLog(gameMsg);
          } else if (intent.debuff) {
            if (intent.strDown) strength = Math.max(0, strength - intent.strDown);
            if (intent.dexDown) dexterity = Math.max(0, dexterity - intent.dexDown);
            gameMsg = `${e.name} ÎîîÎ≤ÑÌîÑ!`;
            addCombatLog(gameMsg);
          }
          
          // ÏïΩÌôî/Ï∑®ÏïΩ Ï†ÅÏö©
          if (intent.weak) weak += intent.weak;
          
          render();
        }, delay);
        
        delay += 500;
      });
      
      // ÌÑ¥ Ï¢ÖÎ£å Ï≤òÎ¶¨
      setTimeout(() => {
        if (hp <= 0) {
          defeat();
          return;
        }
        
        startNewTurn();
      }, delay + 300);
    }

    function startNewTurn() {
      turn++;
      firstTurn = false;
      cantDrawThisTurn = false;
      
      // ÏÉÅÌÉú Í∞êÏÜå
      block = 0;
      weak = Math.max(0, weak - 1);
      vulnerable = Math.max(0, vulnerable - 1);
      
      // ÎèÖ Ï≤òÎ¶¨
      if (poison > 0) {
        hp -= poison;
        poison--;
        addCombatLog(`ÎèÖ ‚Üí ${poison + 1} Îç∞ÎØ∏ÏßÄ`, 'dmg');
        if (hp <= 0) {
          defeat();
          return;
        }
      }
      
      // ÏïÖÎßàÌòïÏÉÅ
      if (powers.demon) {
        strength += powers.demon;
        addCombatLog(`ÏïÖÎßàÌòïÏÉÅ ‚Üí Ìûò+${powers.demon}`);
      }
      
      // ÌñâÎ≥µÌïú ÍΩÉ
      const flower = relics.find(r => r.energyEvery);
      if (flower) {
        flower.turnCount = (flower.turnCount || 0) + 1;
        if (flower.turnCount >= flower.energyEvery) {
          flower.turnCount = 0;
          energy++;
          addCombatLog(`ÌñâÎ≥µÌïú ÍΩÉ ‚Üí ÏóêÎÑàÏßÄ+1`);
        }
      }
      
      // Ï†Å ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      enemies.forEach(e => {
        if (e.hp <= 0) return;
        e.block = 0;
        e.weak = Math.max(0, e.weak - 1);
        e.vulnerable = Math.max(0, e.vulnerable - 1);
        e.strength += e.ritual || 0;
        e.intent = e.atks[rand(0, e.atks.length - 1)];
      });
      
      // ÏÜêÌå® Î≤ÑÎ¶¨Í≥† ÎìúÎ°úÏö∞
      discardPile = discardPile.concat(hand);
      hand = [];
      energy = maxEnergy;
      
      for (let i = 0; i < 5; i++) drawCard();
      
      animating = false;
      gameMsg = `ÌÑ¥ ${turn}`;
      render();
    }

    function combatVictory() {
      aiMsg = 'Ï†ÅÏùÑ Î¨ºÎ¶¨Ï≥§ÏäµÎãàÎã§!';
      gameMsg = '';
      combatLogs = [];
      
      // Î∂àÌÉÄÎäî Ìîº
      relics.forEach(r => { 
        if (r.heal) hp = Math.min(maxHp, hp + r.heal); 
      });
      
      // ÎºàÏóê Î∂ôÏùÄ Í≥†Í∏∞
      const meat = relics.find(r => r.lowHpHeal);
      if (meat && hp <= maxHp * 0.5) {
        hp = Math.min(maxHp, hp + meat.lowHpHeal);
      }
      
      const enemy = enemies[0];
      const isBoss = enemy.boss;
      const isElite = enemy.elite;
      
      rewardGold = isBoss ? rand(95, 105) : isElite ? rand(25, 35) : rand(10, 20);
      
      // Ïπ¥Îìú Î≥¥ÏÉÅ
      const pool = Object.keys(CARDS).filter(k => k !== 'strike' && k !== 'defend');
      rewardCards = shuffle(pool).slice(0, 3).map(k => createCard(k));
      
      // Ìè¨ÏÖò (40% ÌôïÎ•†)
      const potionPool = Object.keys(POTIONS);
      rewardPotion = Math.random() < 0.4 ? { ...POTIONS[potionPool[rand(0, potionPool.length - 1)]], uid: uid() } : null;
      
      // ÏóòÎ¶¨Ìä∏/Î≥¥Ïä§ Î†êÎ¶≠
      if (isElite || isBoss) {
        const ownedKeys = relics.map(r => r.key);
        const relicPool = Object.keys(RELICS).filter(k => !ownedKeys.includes(k));
        if (relicPool.length > 0) {
          const key = relicPool[rand(0, relicPool.length - 1)];
          rewardRelic = { ...RELICS[key], key, uid: uid() };
        }
      }

      render();
      
      setTimeout(() => {
        if (isBoss && floor >= 13) {
          victory();
        } else {
          state = 'reward';
          render();
        }
      }, 800);
    }

    function collectGold() { gold += rewardGold; rewardGold = 0; render(); }
    function collectPotion() { 
      if (rewardPotion && potions.length < 3) potions.push(rewardPotion); 
      rewardPotion = null; 
      render(); 
    }
    function collectRelic() {
      if (rewardRelic) relics.push(rewardRelic);
      rewardRelic = null;
      render();
    }
    function selectRewardCard(i) { deck.push(rewardCards[i]); rewardCards = []; render(); }
    function skipRewardCard() { rewardCards = []; render(); }
    function finishReward() { 
      rewardCards = []; rewardGold = 0; rewardPotion = null; rewardRelic = null;
      state = 'map'; 
      gameMsg = '';
      autoSave(); 
      render(); 
    }

    // ========== ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ Î™®Îã¨ ==========
    let selectedPotionIdx = -1;
    
    function showRelicInfo(i) {
      const r = relics[i];
      if (!r) return;
      
      $('itemInfoTitle').textContent = 'üéÅ Î†êÎ¶≠';
      $('itemInfoEmoji').textContent = r.emoji;
      $('itemInfoName').textContent = r.name;
      $('itemInfoDesc').textContent = r.desc;
      $('itemInfoAction').innerHTML = '';
      $('itemInfoModal').classList.remove('hidden');
    }
    
    function showPotionInfo(i) {
      const p = potions[i];
      selectedPotionIdx = i;
      
      if (!p) {
        $('itemInfoTitle').textContent = 'üß™ Ìè¨ÏÖò';
        $('itemInfoEmoji').textContent = '‚óã';
        $('itemInfoName').textContent = 'Îπà Ïä¨Î°Ø';
        $('itemInfoDesc').textContent = 'Ìè¨ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§.';
        $('itemInfoAction').innerHTML = '';
      } else {
        $('itemInfoTitle').textContent = 'üß™ Ìè¨ÏÖò';
        $('itemInfoEmoji').textContent = p.emoji;
        $('itemInfoName').textContent = p.name;
        $('itemInfoDesc').textContent = p.desc;
        
        // Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìè¨ÏÖòÏù∏ÏßÄ Ï≤¥ÌÅ¨
        const combatOnly = p.dmg || p.str || p.dex || p.weakAll || p.poison || p.energy;
        const canUse = !combatOnly || state === 'combat';
        
        let actionHtml = `<button class="btn btn-gold btn-sm" onclick="usePotionFromModal()" ${canUse ? '' : 'disabled'}>ÏÇ¨Ïö©ÌïòÍ∏∞</button>`;
        if (!canUse) {
          actionHtml += '<p class="muted" style="margin-top:8px;font-size:12px;">Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö© Í∞ÄÎä•</p>';
        }
        actionHtml += `<button class="btn btn-dark btn-sm" style="margin-left:8px;" onclick="discardPotion()">Î≤ÑÎ¶¨Í∏∞</button>`;
        $('itemInfoAction').innerHTML = actionHtml;
      }
      
      $('itemInfoModal').classList.remove('hidden');
    }
    
    function usePotionFromModal() {
      closeItemInfo();
      if (selectedPotionIdx >= 0) {
        usePotion(selectedPotionIdx);
      }
    }
    
    function discardPotion() {
      if (selectedPotionIdx >= 0 && potions[selectedPotionIdx]) {
        const p = potions[selectedPotionIdx];
        potions.splice(selectedPotionIdx, 1);
        gameMsg = `${p.name}ÏùÑ(Î•º) Î≤ÑÎ†∏ÏäµÎãàÎã§.`;
        render();
      }
      closeItemInfo();
    }
    
    function closeItemInfo() {
      $('itemInfoModal').classList.add('hidden');
      selectedPotionIdx = -1;
    }

    function usePotion(i) {
      const p = potions[i];
      if (!p) return;
      
      if (state !== 'combat' && (p.dmg || p.str || p.dex || p.weakAll || p.poison || p.energy)) {
        gameMsg = 'Ï†ÑÌà¨ Ï§ëÏóêÎßå ÏÇ¨Ïö© Í∞ÄÎä•!';
        render();
        return;
      }
      
      potions.splice(i, 1);
      
      if (p.dmg) {
        const e = enemies.find(en => en.hp > 0);
        if (e) {
          const absorbed = Math.min(p.dmg, e.block);
          e.block -= absorbed;
          e.hp -= (p.dmg - absorbed);
          gameMsg = `${p.name}! ${p.dmg} Îç∞ÎØ∏ÏßÄ!`;
          addCombatLog(gameMsg, 'dmg');
          setTimeout(() => checkEnemyDeath(), 300);
        }
      }
      if (p.block) { 
        gainBlock(p.block); 
        gameMsg = `${p.name}! ${p.block} Î∞©Ïñ¥!`; 
        addCombatLog(gameMsg, 'block');
      }
      if (p.str) { 
        strength += p.str; 
        gameMsg = `${p.name}! Ìûò+${p.str}!`; 
      }
      if (p.dex) { 
        dexterity += p.dex; 
        gameMsg = `${p.name}! ÎØºÏ≤©+${p.dex}!`; 
      }
      if (p.healPct) { 
        const heal = Math.floor(maxHp * p.healPct);
        hp = Math.min(maxHp, hp + heal); 
        gameMsg = `${p.name}! ${heal} ÌöåÎ≥µ!`; 
        addCombatLog(gameMsg, 'heal');
      }
      if (p.weakAll) {
        enemies.forEach(e => { if (e.hp > 0) e.weak += p.weakAll; });
        gameMsg = `${p.name}! Ï†Å Ï†ÑÏ≤¥ ÏïΩÌôî${p.weakAll}!`;
      }
      if (p.poison) {
        const e = enemies.find(en => en.hp > 0);
        if (e) {
          e.poison = (e.poison || 0) + p.poison;
          gameMsg = `${p.name}! ÎèÖ ${p.poison}!`;
        }
      }
      if (p.energy) {
        energy += p.energy;
        gameMsg = `${p.name}! ÏóêÎÑàÏßÄ+${p.energy}!`;
      }
      if (p.randomPower) {
        const powers = ['strength', 'endBlock', 'strPerTurn'];
        const chosen = powers[rand(0, powers.length - 1)];
        if (chosen === 'strength') strength += 1;
        else if (chosen === 'endBlock') powers.metal = (powers.metal || 0) + 3;
        else powers.demon = (powers.demon || 0) + 1;
        gameMsg = `${p.name}! ÎûúÎç§ ÌååÏõå ÌöçÎìù!`;
      }
      
      render();
    }

    // Ïù¥Î≤§Ìä∏
    function triggerEvent() { 
      const pool = EVENTS.filter(e => e.id !== 'bigFish' || !currentEvent || currentEvent.id !== 'bigFish');
      currentEvent = pool[rand(0, pool.length - 1)]; 
      aiMsg = 'Î¨¥Ïñ∏Í∞Ä Î∞úÍ≤¨!'; 
      gameMsg = '';
      state = 'event'; 
    }
    
    function chooseEvent(i) {
      const c = currentEvent.choices[i];
      let msg = '';
      
      if (c.healPct) { 
        const heal = Math.floor(maxHp * c.healPct);
        hp = Math.min(maxHp, hp + heal);
        msg = `HP ${heal} ÌöåÎ≥µ!`;
      }
      if (c.maxHp) { maxHp += c.maxHp; hp += c.maxHp; msg = `ÏµúÎåÄ HP +${c.maxHp}!`; }
      if (c.maxHpLoss) { maxHp -= c.maxHpLoss; hp = Math.min(hp, maxHp); msg = `ÏµúÎåÄ HP -${c.maxHpLoss}...`; }
      if (c.gold) { gold += c.gold; msg = `Í∏àÌôî +${c.gold}!`; }
      if (c.damage) { hp -= c.damage; msg += ` HP -${c.damage}`; }
      if (c.relic || c.rareRelic) {
        const ownedKeys = relics.map(r => r.key);
        const pool = Object.keys(RELICS).filter(k => !ownedKeys.includes(k));
        if (pool.length > 0) {
          const key = pool[rand(0, pool.length - 1)];
          relics.push({ ...RELICS[key], key, uid: uid() });
          msg = `${RELICS[key].name} ÌöçÎìù!`;
        }
      }
      if (c.relicKey) {
        const ownedKeys = relics.map(r => r.key);
        if (!ownedKeys.includes(c.relicKey)) {
          relics.push({ ...RELICS[c.relicKey], key: c.relicKey, uid: uid() });
          msg = `${RELICS[c.relicKey].name} ÌöçÎìù!`;
        }
      }
      if (c.upgradeRandom) {
        const upgradeable = deck.filter(card => !card.upgraded);
        if (upgradeable.length > 0) {
          upgradeCard(upgradeable[rand(0, upgradeable.length - 1)]);
          msg = 'ÎûúÎç§ Ïπ¥Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú!';
        }
      }
      if (c.removeRandom && deck.length > 5) {
        deck.splice(rand(0, deck.length - 1), 1);
        msg = 'ÎûúÎç§ Ïπ¥Îìú Ï†úÍ±∞!';
      }
      if (c.randomWheel) {
        const effects = [
          () => { gold += 100; return 'Í∏àÌôî +100!'; },
          () => { hp = Math.min(maxHp, hp + Math.floor(maxHp * 0.25)); return 'HP 25% ÌöåÎ≥µ!'; },
          () => { hp -= 10; return 'HP -10...'; },
          () => { maxHp += 5; hp += 5; return 'ÏµúÎåÄ HP +5!'; },
          () => { const u = deck.filter(c => !c.upgraded); if (u.length) upgradeCard(u[0]); return 'Ïπ¥Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú!'; }
        ];
        const effect = effects[rand(0, effects.length - 1)];
        msg = effect();
      }
      if (c.combat === 'elite') {
        currentEvent = null;
        startCombat('elite');
        return;
      }
      
      gameMsg = msg || 'ÏïÑÎ¨¥ ÏùºÎèÑ ÏùºÏñ¥ÎÇòÏßÄ ÏïäÏïòÎã§';
      currentEvent = null;
      render();
      setTimeout(() => { state = 'map'; gameMsg = ''; autoSave(); render(); }, 1500);
    }

    // Ìú¥ÏãùÏ≤ò
    function triggerRest() {
      aiMsg = 'Î™®Îã•Î∂àÏùò Ïò®Í∏∞...';
      gameMsg = '';
      state = 'rest';
    }
    
    function restHeal() {
      const heal = Math.floor(maxHp * 0.3);
      hp = Math.min(maxHp, hp + heal);
      gameMsg = `HP ${heal} ÌöåÎ≥µ!`;
      render();
      setTimeout(() => { state = 'map'; gameMsg = ''; autoSave(); render(); }, 1000);
    }
    
    function restUpgrade() {
      showUpgrade();
    }

    // ÏÉÅÏ†ê
    function triggerShop() {
      const cardPool = Object.keys(CARDS).filter(k => k !== 'strike' && k !== 'defend');
      const cards = shuffle(cardPool).slice(0, 6).map(k => ({
        item: createCard(k),
        price: CARDS[k].type === 'power' ? rand(100, 160) : rand(50, 120),
        sold: false
      }));
      
      const potionPool = Object.keys(POTIONS);
      const pots = shuffle(potionPool).slice(0, 3).map(k => ({
        item: { ...POTIONS[k], key: k, uid: uid() },
        price: rand(40, 80),
        sold: false
      }));
      
      const ownedRelics = relics.map(r => r.key);
      const relicPool = Object.keys(RELICS).filter(k => !ownedRelics.includes(k));
      const shopRelics = shuffle(relicPool).slice(0, 2).map(k => ({
        item: { ...RELICS[k], key: k, uid: uid() },
        price: rand(150, 250),
        sold: false
      }));
      
      shopItems = { 
        cards, 
        potions: pots, 
        relics: shopRelics,
        removePrice: 75,
        removeUsed: false
      };
      aiMsg = 'ÏÉÅÏù∏Ïùò ÎØ∏ÏÜå...';
      gameMsg = '';
      state = 'shop';
    }
    
    function buyCard(i) {
      const it = shopItems.cards[i];
      if (!it || it.sold) return;
      if (gold < it.price) { gameMsg = 'Í∏àÌôî Î∂ÄÏ°±!'; render(); return; }
      gold -= it.price;
      deck.push(it.item);
      it.sold = true;
      gameMsg = `${it.item.name} Íµ¨Îß§!`;
      render();
    }
    
    function buyPotion(i) {
      const it = shopItems.potions[i];
      if (!it || it.sold) return;
      if (gold < it.price) { gameMsg = 'Í∏àÌôî Î∂ÄÏ°±!'; render(); return; }
      if (potions.length >= 3) { gameMsg = 'Ìè¨ÏÖò Í∞ÄÎìù!'; render(); return; }
      gold -= it.price;
      potions.push(it.item);
      it.sold = true;
      gameMsg = `${it.item.name} Íµ¨Îß§!`;
      render();
    }
    
    function buyRelic(i) {
      const it = shopItems.relics[i];
      if (!it || it.sold) return;
      if (gold < it.price) { gameMsg = 'Í∏àÌôî Î∂ÄÏ°±!'; render(); return; }
      gold -= it.price;
      relics.push(it.item);
      it.sold = true;
      gameMsg = `${it.item.name} ÌöçÎìù!`;
      render();
    }
    
    function shopRemoveCard() {
      if (shopItems.removeUsed) return;
      if (gold < shopItems.removePrice) { gameMsg = 'Í∏àÌôî Î∂ÄÏ°±!'; render(); return; }
      gold -= shopItems.removePrice;
      showRemove();
    }
    
    function exitShop() { 
      state = 'map'; 
      gameMsg = ''; 
      autoSave();
      render(); 
    }

    // Î≥¥Î¨º
    function triggerTreasure() {
      const ownedKeys = relics.map(r => r.key);
      const pool = Object.keys(RELICS).filter(k => !ownedKeys.includes(k));
      
      if (!pool.length) { 
        gold += 50;
        gameMsg = 'ÎåÄÏã† Í∏àÌôî 50Í∞úÎ•º Ï∞æÏïòÏäµÎãàÎã§!';
        aiMsg = '';
        render();
        setTimeout(() => { state = 'map'; gameMsg = ''; autoSave(); render(); }, 1500);
        return; 
      }
      
      const k = pool[rand(0, pool.length - 1)];
      relics.push({ ...RELICS[k], key: k, uid: uid() });
      gameMsg = `${RELICS[k].name} ÌöçÎìù!`;
      aiMsg = 'Î≥¥Î¨º Î∞úÍ≤¨!';
      render();
      setTimeout(() => { 
        state = 'map'; 
        gameMsg = ''; 
        autoSave();
        render(); 
      }, 1500);
    }

    function victory() { state = 'victory'; aiMsg = ''; gameMsg = ''; localStorage.removeItem('slayv2-auto'); render(); }
    function defeat() { aiMsg = 'Ïñ¥Îë† ÏÜçÏúºÎ°ú...'; gameMsg = ''; state = 'defeat'; localStorage.removeItem('slayv2-auto'); render(); }
    function goToMenu() { state = 'menu'; aiMsg = ''; gameMsg = ''; render(); }

    // Ï¥àÍ∏∞Ìôî
    render();
  </script>

</body>
</html>
